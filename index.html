<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- FAVICON SETUP -->
    <link rel="icon" type="image/png" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT_mSxRlMNjXZ6wbc4YwK_AwsNPp_oLhl8SgwIIVgH2FA&s=10">

    <!-- Firebase App (base) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
    // Aapka Real Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyCtM17whd74HdOa3OHqC39cGdWKs2rGxew",
        authDomain: "silentgridnex-6cd37.firebaseapp.com",
        projectId: "silentgridnex-6cd37",
        storageBucket: "silentgridnex-6cd37.firebasestorage.app",
        messagingSenderId: "1000743152636",
        appId: "1:1000743152636:web:af4b984be6cd805446e079"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage(); 
</script>

    <title>AlphaVault/X01- Secure Terminal</title>
    <!-- PDF Library for Notebook -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* --- UPDATED ENTRY PAGE STYLES --- */
        #entry-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), 
                        url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjrD4BcELWNBaUkmh-Z9FCYvvq7HH0S7jKGZv2Zf6U4AB5hQviq3FTPewmgRZhuZd4L7e6u-0MRXVYv3dqOdTb20deLIapx0ms59U2P7z7tigCQRxcRRCB_2LlMma2fgNjiJrBNGqkOPhBmFJ8hpIKKBaq03ZG0RNBKRXCUF3peQMftY6hzMti2r_E5dsSv/s736/We%20are%20anonymus.jpeg') no-repeat center center;
            background-size: cover;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .entry-glass-box {
            background: rgba(10, 10, 10, 0.85); 
            backdrop-filter: blur(15px);
            padding: 0; 
            border: 1px solid #444;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
            border-radius: 4px;
            overflow: hidden;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .entry-header {
            background: #a00000;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #ff0000;
        }

        .entry-header i {
            color: #fff;
            font-size: 14px;
        }

        .entry-header span {
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .entry-content {
            padding: 30px 25px;
            text-align: center;
        }

        .entry-glass-box h2 {
            color: #ffffff;
            font-size: 14px;
            letter-spacing: 1px;
            margin-bottom: 25px;
            text-transform: uppercase;
            font-weight: normal;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .entry-input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .entry-input-wrapper i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #a00000;
            font-size: 12px;
        }

        #initialPhraseInput {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            border-left: 3px solid #a00000;
            padding: 12px 12px 12px 35px;
            color: #fff;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            box-sizing: border-box;
            outline: none;
            font-size: 11px;
            transition: 0.3s;
        }

        #initialPhraseInput:focus {
            border-color: #a00000;
            box-shadow: 0 0 10px rgba(160, 0, 0, 0.3);
        }

        .entry-btn {
            background: #a00000;
            color: white;
            border: none;
            padding: 12px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            width: 100%;
            letter-spacing: 2px;
            font-size: 11px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            transition: 0.3s;
        }

        .entry-btn:hover {
            background: #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
        }

        #main-wrapper { 
            display: none; 
            width: 100%; 
            min-height: 100vh; 
            flex-direction: column; 
        }

        body {
            background-color: #121212; 
            color: #e0e0e0; 
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* GLOBAL CODING FONT */ 
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
            letter-spacing: 0.5px; 
            font-size: 12px;
        }

        .container {
            width: 100%; 
            flex-grow: 1; 
            background-color: #1a1a1a; 
            border: none;
            box-shadow: none;
            overflow: hidden;
            box-sizing: border-box;
        }

        #grid-toast {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #0a0a0a;
            border: 1px solid #a00000; 
            color: #00ff41;
            padding: 12px 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            font-size: 11px;
            z-index: 2000;
            box-shadow: 0 0 20px rgba(160, 0, 0, 0.4);
            border-left: 5px solid #a00000; 
            text-transform: uppercase;
            animation: toastSlide 0.5s ease-out;
        }
        @keyframes toastSlide { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        #uploadSuccessModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); 
            backdrop-filter: blur(4px); 
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .success-box {
            background: rgba(10, 10, 10, 0.7); 
            backdrop-filter: blur(15px); 
            border: 1px solid #a00000; 
            width: 90%;
            max-width: 480px;
            padding: 0;
            box-shadow: none; 
            text-align: center;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .console-log {
            background: rgba(0, 0, 0, 0.5); 
            margin: 20px;
            padding: 15px;
            border: 1px solid #222;
            text-align: left;
            font-size: 10px;
            color: #00ff41;
            line-height: 1.5;
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
        }

        /* --- UPDATED HEADER FLEX STYLES (HEADER SIZE INCREASED) --- */
        .secret-header {
            background: 
                linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiPvIa3GcpuSFFz-bYNAZIbNXXQkkZ6jgcJ3pM-fZ1nOFylpNxus4-kYH47wj_LI-JSUPAOKXo5hN28A9w5hUmSBPWFk3COqIw1WNr_aevx9LopA0q1HIOnmZf_xA_HzKN4SsIAcQnl1lkgvLT7n4FwaACwsFnbL-R-fy1spT-DSceKrGsQ9erz8RO0IIYe/s736/c5790720-08f0-4ea0-820a-24520d636481.jpeg'),
                linear-gradient(135deg, #222222 0%, #1a1a1a 100%);
            background-size: cover;
            background-position: center;
            padding: 100px 40px; /* SIZE INCREASED FROM 40px TO 100px */
            text-align: left; 
            position: relative;
            border-bottom: 2px solid #555555; 
            overflow: hidden;
        }

        .header-content {
            position: relative;
            z-index: 1;
            padding-bottom: 5px;
            margin-top: -5px; 
            max-width: 100%; 
        }

        .secret-header h1 {
            color: #ffffff;
            font-size: 18px;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 3px; 
            font-family: 'Arial Black', sans-serif;
            line-height: 1;
            position: relative;
            display: inline-block;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
        }

        .secret-header h1::after {
            background: linear-gradient(to bottom, rgba(255,255,255,0.1) 0%, transparent 70%);
            -webkit-background-clip: text;
            background-clip: text;
            content: "Alpha02nex";
            font-size: 18px;
            letter-spacing: 3px;
            font-family: 'Arial Black', sans-serif;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            color: transparent;
            transform: scaleY(-1);
            filter: blur(0.5px);
            opacity: 0.6;
            transform-origin: top;
            pointer-events: none;
            display: block;
        }

        .secret-header p {
            color: #c0c0c0;
            font-size: 10px;
            margin-top: 8px; 
            font-style: normal;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            position: relative;
            display: inline-block;
            padding-bottom: 2px;
            letter-spacing: 0.8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .secret-header p::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100%;
            height: 1px;
            background-color: #777777;
        }
        
        .menu-wrapper {
            width: 100%;
            background-color: #1a1a1a;
            border-bottom: 1px solid #333333;
            position: relative;
        }
        
        .menu-toggle {
            background-color: #121212;
            color: #ff0000;
            padding: 12px 20px;
            text-align: left;
            border: none;
            cursor: pointer;
            width: 100%;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-sizing: border-box;
            border-bottom: 1px solid #333333;
            transition: background-color 0.2s;
            outline: none;
        }
        
        .dropdown-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: #1a1a1a;
            position: absolute;
            width: 100%;
            z-index: 100;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            border-bottom: 1px solid #ff0000;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        
        .dropdown-menu.open {
            max-height: 500px;
        }
        
        .dropdown-menu li a {
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            color: #ff0000;
            font-size: 0.8em;
            text-transform: uppercase;
            transition: all 0.2s;
            border-top: 1px solid #2a2a2a;
            cursor: pointer;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .dropdown-menu li a:hover {
            background-color: #2a0000;
            padding-left: 30px;
        }

        .category-container {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
        }

        .category-trigger {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            border-left: 3px solid #a00000;
            padding: 12px 15px;
            color: #ffffff; 
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            transition: 0.3s;
        }

        .category-trigger:hover {
            border-color: #a00000;
            background: #050505;
        }

        .category-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #ff0000;
            border-top: none;
            z-index: 1000;
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .category-list.active {
            max-height: 300px;
            overflow-y: auto; 
        }
        
        /* DELETED: Removed MODIFIED: NEW RULE for OSINT to show all at once (no internal scrolling) */


        .category-list::-webkit-scrollbar {
            width: 8px;
        }
        .category-list::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        .category-list::-webkit-scrollbar-thumb {
            background: #333;
            border: 1px solid #a00000;
            border-radius: 2px;
        }
        .category-list::-webkit-scrollbar-thumb:hover {
            background: #a00000;
        }

        .category-list li {
            padding: 12px 15px;
            color: #ffffff; 
            font-size: 10px;
            text-transform: uppercase;
            cursor: pointer;
            border-top: 1px solid #222;
            transition: 0.2s;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .category-list li:hover {
            background: #2a0000;
            color: #ffffff;
            padding-left: 20px;
        }
        
        /* NEW RULE FOR NETWORK MAP PERMANENT LISTS (Fix for image display) */
        .map-list-permanent {
            position: relative !important; 
            display: block !important;    
            max-height: none !important;  
            overflow-y: hidden !important;
            border: 1px solid #333 !important; 
            border-top: none !important;
            box-shadow: none !important;
            margin-top: -1px !important; 
            width: 100% !important; 
            background: rgba(10, 10, 10, 0.95) !important;
            border-radius: 0 0 4px 4px; /* Optional: adds subtle curve to the bottom */
            /* FIX: Added top: 0 to ensure list starts right after the header */
            top: 0 !important; 
        }
        
        /* Ensure no double border where trigger meets list */
        #network-map-section .category-container .category-trigger {
            border-bottom: 0 !important; /* Remove bottom border from trigger */
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }


        /* --- SPECIAL STYLES FOR SECURE COMMS DROPDOWN (SMALLER) --- */
        #secure-comms-section .category-container {
            width: 180px; /* REDUCED SIZE TO 180px */
            margin: 10px 0 20px 0;
        }

        #secure-comms-section .category-trigger {
            background: #a00000; 
            border: 1px solid #333;
            padding: 6px 10px; /* Reduced padding */
            font-size: 9px; /* Reduced font */
            cursor: default; 
            pointer-events: none; 
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }
        
        #secure-comms-section .category-trigger i {
            display: none;
        }

        #secure-comms-section .category-list {
            width: 180px; /* REDUCED SIZE TO 180px */
        }

        #comms-cat-list {
            position: relative !important; 
            display: block !important;    
            max-height: none !important;  
            overflow-y: visible !important;
            border: 1樣子 solid #333;
            box-shadow: none;
            margin-top: -1px; 
            opacity: 1 !important;
        }
        
        .comms-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comms-logo {
            width: 16px; /* Smaller logo */
            height: 16px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #a00000;
            background: #000;
        }
        
        #secure-comms-section .category-list li {
            padding: 8px 10px; /* Smaller list items */
            font-size: 9px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }
        
        /* NEW STYLES FOR OSINT ICONS */
        #network-map-section .comms-logo {
            border: 1px solid #004d99; /* Blue border for OSINT */
            background: #000;
        }
        
        /* Added: Specific styles to force all map lists to be permanently open and smaller */
        /* NOTE: These styles are now largely superseded by the new dynamic list structure, but kept for context. */
        #network-map-section .category-container .category-trigger {
            background: #000; /* Revert to generic dark */
            border-left: 3px solid #a00000; /* Revert to generic red */
            padding: 12px 15px; 
            font-size: 11px; 
            cursor: pointer; 
            pointer-events: auto; /* Re-enable pointer events for the dropdown trigger */
            border-bottom: 1px solid #333; /* Re-add bottom border if it's a list trigger */
        }
        #network-map-section .category-container .category-trigger i {
            display: inline-block; /* Re-enable dropdown arrow */
        }
        
        /* MODIFIED: Generic selector to apply smaller size to all lists in network map section */
        #network-map-section .category-list li {
            padding: 8px 10px; /* Reduced vertical padding from 12px to 8px */
            font-size: 9px;   /* Reduced font size from 10px to 9px */
        }
        
        /* Ensure the hover styles are available for the new dynamic list. */
        #network-map-section #network-map-osint-list li:hover { /* Updated ID */
             background: #2a0000; /* Default hover red */
             color: #ffffff;
             padding-left: 20px;
        }
        /* Specific OSINT blue hover, as seen in the original image list. */
        #network-map-section #network-map-osint-list li:hover {
            background: #0066cc; /* Overriding to blue */
            color: #ffffff;
            padding-left: 20px;
        }
        
        /* Special style for the OSINT List Trigger to match the image's blue bar */
        #network-map-section #osint-list-trigger {
            background: #004d99 !important; 
            border-left: 3px solid #0066cc !important; 
            border-bottom: 0 !important; 
            cursor: default !important;
            pointer-events: none !important;
            font-size: 11px !important;
            color: white !important;
            padding: 12px 15px !important;
            display: flex;
            justify-content: flex-start; /* Aligned left, no icon needed */
        }


        /* --- UPDATED BIGGER WINDOW FOR RECORDS --- */
        #commsSmallWindow {
            display: none;
            position: fixed; 
            width: 500px; 
            background: #0a0a0a;
            border: 1px solid #333;
            border-top: 1px solid #555;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9);
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
            z-index: 3000; 
            animation: fadeIn 0.3s;
        }

        #commsWindowContent {
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            font-size: 10px;
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
        }
        
        /* --- NEW WINDOW LOWER RIGHT STYLE (UPDATED: BIGGER & TRANSPARENT) --- */
        #comms-monitor-window {
            position: fixed;
            bottom: 220px; /* Adjusted to prevent overlap */
            right: 20px;
            width: 600px; /* Increased Width */
            height: 350px; /* Added Height */
            z-index: 1000;
            display: block;
            background-color: rgba(0, 0, 0, 0.2) !important; /* Transparent Background */
            backdrop-filter: blur(2px); /* Slight Blur */
            border: 1px solid #444;
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
        }

        #comms-monitor-window .win-bar {
            background: rgba(0, 0, 0, 0.4); /* Transparent Title Bar */
            border-bottom: 1px solid #444;
        }

        .status-bar {
            background-color: #a00000;
            color: #ffffff;
            text-align: center;
            padding: 6px 0;
            font-weight: bold;
            letter-spacing: 1px; 
            border-bottom: 2px solid #700000;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0,0,0,0.6);
            font-size: 0.7em;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .content-area {
            max-width: 900px; 
            margin: 0 auto;
            padding: 20px; 
            line-height: 1.5;
            background-color: #1a1a1a;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }
        
        .date {
            color: #ffffff; 
            font-size: 0.75em;
            margin-bottom: 12px;
            font-weight: bold;
            border-left: 3px solid #ff0000;
            padding-left: 10px;
            text-transform: uppercase;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .notebook-container {
            border: 1px solid #333;
            background: #0a0a0a;
            border-radius: 4px;
            overflow: hidden;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        #notebook-title {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            border-left: 3px solid #a00000;
            padding: 10px 15px;
            color: #fff;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            box-sizing: border-box;
            outline: none;
            font-size: 11px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #notebook-title::placeholder {
            color: #444;
        }

        .editor-toolbar {
            background: #222;
            padding: 10px;
            border-bottom: 1px solid #444;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .editor-toolbar button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            font-size: 10px; 
            transition: 0.2s;
        }

        .editor-toolbar button:hover {
            background: #a00000;
            border-color: #ff0000;
        }

        #rich-editor {
            min-height: 400px;
            padding: 20px;
            color: #e0e0e0;
            outline: none;
            font-family: 'Arial', sans-serif; /* Note: Body text of rich editor usually stays readable sans-serif, but surrounding is code */
            background: #111;
            overflow-y: auto;
            font-size: 13px;
        }

        #rich-editor img { max-width: 100%; height: auto; margin: 10px 0; display: block; }
        #rich-editor video, #rich-editor audio { max-width: 100%; margin: 10px 0; display: block; }
        #rich-editor iframe { max-width: 100%; margin: 10px 0; }

        .editor-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .editor-modal {
            background: #1a1a1a;
            border: 1px solid #a00000; 
            width: 90%;
            max-width: 450px;
            padding: 0;
            box-shadow: 0 0 30px rgba(160, 0, 0, 0.2);
            animation: modalSlide 0.3s ease-out;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }
        
        /* NEW: Network Warning & Delete Confirm Modal Style */
        .system-modal {
            background: #1a1a1a;
            /* **MODIFICATION 1: Faded Red Border** */
            border: 1px solid #700000; /* Darker/faded red border */
            width: 90%;
            max-width: 480px;
            padding: 0;
            /* **MODIFICATION 2: Removed red glow** */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            animation: modalSlide 0.3s ease-out;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }
        
        .system-modal .modal-header {
            /* **MODIFICATION 3: Faded Red Header** */
            background: #a00000; /* Darker/faded red (same as entry header) */
        }

        @keyframes modalSlide { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-header {
            /* Kept thin style from previous request, modifying color here */
            /* **MODIFICATION 4: Faded Red Header** */
            background: #a00000; 
            color: white;
            padding: 5px 15px; 
            font-size: 10px; 
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            justify-content: space-between;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .modal-body { padding: 20px; }
        
        .modal-label {
            color: #a00000; 
            display: block;
            margin-bottom: 10px;
            font-size: 10px; 
            text-transform: uppercase;
            font-weight: bold;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .modal-input {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            padding: 12px;
            color: #888888; 
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            box-sizing: border-box;
            outline: none;
            margin-bottom: 20px;
        }

        .modal-input:focus { border-color: #a00000; }

        .modal-actions { display: flex; gap: 10px; }
        
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            font-size: 11px; 
        }

        .btn-confirm { background: #a00000; color: white; } 
        .btn-cancel { background: #333; color: #ccc; }

        /* **MODIFICATION 5: Faded Red Icons/Text in Body** */
        #networkWarning .system-modal i, #deleteConfirmModal .system-modal i {
            color: #a00000; /* Faded/darker red icon */
        }
        /* **MODIFICATION 6: Faded Red Button Background in Body** */
        #networkWarning .system-modal .btn-confirm, #deleteConfirmModal .system-modal #delete-modal-confirm-btn {
            background: #a00000 !important; /* Faded/darker red button */
        }

        .tech-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #a00000, #ff0000, #a00000, transparent);
            margin: 30px 0 20px 0;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .tech-divider::before {
            content: "[ PROTOCOL-X92 ]";
            position: absolute;
            top: -10px;
            font-size: 8px; 
            color: #ff0000;
            background-color: #1a1a1a;
            padding: 0 15px;
            letter-spacing: 3px;
            font-weight: bold;
        }

        .tech-divider::after {
            width: 40px; 
            height: 2px;
            background: #ff0000;
            position: absolute;
            bottom: -1px;
            box-shadow: 0 0 10px #ff0000;
        }

        #upload-section {
            display: none;
            border: 1px solid #333;
            padding: 25px;
            background: linear-gradient(180deg, #121212 0%, #0a0a0a 100%);
            border-radius: 4px;
            position: relative;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        #upload-section::before {
            content: "SECURE NODE";
            position: absolute;
            top: -10px;
            right: 20px;
            background: #a00000;
            font-size: 8px; 
            padding: 2px 10px;
            border-radius: 2px;
            letter-spacing: 2px;
        }

        .upload-flex-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap; 
            align-items: flex-start;
        }

        .upload-left-side {
            flex: 1.2;
            min-width: 250px;
        }

        .upload-right-side {
            flex: 1;
            min-width: 250px;
        }

        /* --- UPDATED WIN-BOX FONT STYLES (Requirement: "DejaVu Sans Mono or Monospace") --- */
        .win-box {
            background: #0a0a0a;
            border: 1px solid #333;
            border-top: 1px solid #555;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
        }

        .win-bar {
            background: linear-gradient(to right, #2a2a2a, #1a1a1a);
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .win-title {
            font-size: 9px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
            font-weight: bold;
        }

        .win-controls {
            display: flex;
            gap: 5px;
        }

        .win-btn {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
        }

        .win-btn.red { background: #ff5f56; }
        .win-btn.yellow { background: #ffbd2e; }
        .win-btn.green { background: #27c93f; }

        .win-body {
            padding: 15px;
            font-size: 10px;
            color: #00ff41;
            line-height: 1.6;
            min-height: 180px;
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
        }

        /* --- REQUIREMENT: SECURE COMMS BLUE COLOR & FONT --- */
        /* --- ADDED: #upload-section .win-body to apply blue color to Node_Console.exe --- */
        #secure-comms-section .win-body,
        #comms-monitor-window .win-body,
        #commsSmallWindow .win-body,
        #upload-section .win-body {
            color: #569cd6 !important; /* BLUE COLOR */
            font-family: 'DejaVu Sans Mono', monospace !important; /* ENSURE FONT */
        }

        .upload-form label {
            /* Kept #ff0000 for consistency with other red labels/elements */
            display: block;
            margin: 15px 0 5px;
            color: #ff0000;
            text-transform: uppercase;
            font-size: 0.7em; 
            letter-spacing: 1px;
            font-weight: bold;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .upload-form input[type="text"], 
        .upload-form textarea {
            width: 100%;
            background: rgba(255, 255, 0, 0.05);
            border: 1px solid #444;
            border-left: 2px solid #a00000;
            color: #ffffff;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            box-sizing: border-box;
            outline: none;
            transition: all 0.3s;
            font-size: 11px;
        }

        /* FIX: INCREASE EDIT MODAL TEXTAREA HEIGHT */
        #editLogModal textarea.modal-input {
            height: 250px; /* Increased height for easier reading/editing of long content */
            resize: vertical; /* Allow vertical resize only */
        }
        
        .file-drop-zone {
            border: 2px dashed #444;
            padding: 15px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(0,0,0,0.2);
            width: 120px; 
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .file-drop-zone i {
            color: #a00000; /* Kept for consistency */
            font-size: 1.8em !important; 
            margin-bottom: 8px !important;
        }

        .file-drop-zone p {
            font-size: 8px !important;
            margin: 0 !important;
            line-height: 1.2;
            text-transform: uppercase;
        }

        .btn-submit {
            background: #a00000;
            color: white;
            border: none;
            padding: 12px 25px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            width: 100%;
            letter-spacing: 2px;
            font-size: 11px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .success-card {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        .success-layout-wrapper { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 20px; }
        .small-preview { width: 90px; height: 90px; background-color: #222; border: 1px solid #555; object-fit: cover; display: none; flex-shrink: 0; }

        .result-bar {
            background-color: #707070;
            color: #e0e0e0;
            padding: 8px 15px;
            margin-bottom: 8px;
            font-size: 0.75em; 
            display: block;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }
        .bar-wide { width: 100%; box-sizing: border-box; }
        .bar-short { width: 40%; box-sizing: border-box; }
        .bar-description { height: auto; min-height: 50px; white-space: pre-wrap; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { transform: translateY(0); opacity: 1; } }

        /* DATA HISTORY - PROFESSIONAL BLACK/GRAY THEME */
        #history-section {
            display: none;
            background-color: #0b0b0b; /* Deep matte black background */
            border: 1px solid #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); /* Added depth */
        }

        .history-header-bar {
            /* Professional Dark Gray Gradient instead of flat color */
            background: linear-gradient(180deg, #1f1f1f 0%, #111111 100%);
            padding: 10px 15px;
            border-bottom: 2px solid #a00000; /* Kept red accent line for theme consistency */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .history-header-bar h2 { 
            margin: 0; 
            color: #d0d0d0; /* Changed to soft gray text */
            font-size: 11px; 
            text-transform: uppercase; 
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
            letter-spacing: 2px;
        }

        .history-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
        }

        /* TABLE HEADERS - Professional Dark Gray */
        .history-table th { 
            background-color: #1a1a1a; /* Changed from Red to Dark Gray */
            color: #e0e0e0; /* Light gray text */
            font-size: 9px; 
            padding: 12px 10px; 
            text-align: left; 
            border: 1px solid #2a2a2a; /* Subtle border */
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* TABLE CELLS - Unique Black/Gray Tones */
        .history-table td { 
            background-color: #0e0e0e; /* Very dark unique black */
            color: #b0b0b0; /* Soft gray text */
            padding: 12px 10px; 
            border: 1px solid #1f1f1f; /* Darker borders */
            font-size: 10px; 
            transition: background-color 0.2s ease;
        }

        /* ZEBRA STRIPING - Slightly lighter gray */
        .history-table tr:nth-child(even) td { 
            background-color: #141414; 
        }

        /* HOVER EFFECT - Professional Highlight */
        .history-table tr:hover td {
            background-color: #1f1f1f; /* Highlight row on hover */
            color: #ffffff;
        }

        .status-verified { border-color: #ff3333; background: radial-gradient(circle, #ff3333 30%, transparent 70%); }
        .status-circle { width: 10px; height: 10px; border-radius: 50%; border: 2px solid #555; display: inline-block; }
        .col-topic { color: #ff3333; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .col-topic a { color: #ff3333; text-decoration: none; }
        .col-category { color: #888; font-size: 9px; text-transform: uppercase; font-weight: bold; }

        .progress-container { display: none; margin-top: 20px; background: #222; height: 6px; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #a00000, #ff0000); width: 0%; }

        @media (max-width: 768px) {
            .home-dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* --- TERMINAL SPECIFIC STYLES --- */
        #terminal-console {
            width: 100%;
            height: 250px;
            background: #000;
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
            font-size: 10px;
            color: #569cd6; /* HIGHLIGHTED BLUE */
            overflow-y: auto;
            padding: 5px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        #terminal-input {
            background: transparent;
            border: none;
            color: #569cd6; /* HIGHLIGHTED BLUE */
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
            font-size: 10px;
            outline: none;
            width: 100%;
            margin-left: 5px;
        }

        /* --- DASHBOARD LOG TEXT (KERNEL LOG) --- */
        .dash-log-text {
            color: #569cd6; /* UPDATED TO BLUE */
            font-size: 9px;
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
            line-height: 1.4;
        }

        /* --- DASHBOARD STATUS ROW (ACTIVE NODES) --- */
        .dash-status-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #222;
            padding: 5px 0;
            font-size: 9px;
            color: #aaa;
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
        }
        .dash-status-val { color: #fff; font-weight: bold; }

        /* DELETED FOOTER STYLES WERE HERE */

        .dl-link { 
            color: #ffffff; 
            text-decoration: none; 
            font-weight: bold; 
            border: 1px solid #800000; 
            padding: 1px 6px; 
            background: #800000; 
            transition: 0.3s; 
            cursor: pointer; 
            display: inline-block; 
            border-radius: 1px;
            font-size: 8.5px;
            box-shadow: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }
        /* ADDED STYLE FOR EDIT BUTTON (BLUE) */
        .dl-link.edit-btn {
            background: #004d99; 
            border-color: #0066cc;
        }
        .dl-link:hover { 
            background: #a00000; 
            color: #ffffff; 
            border-color: #cccccc; 
        }

        #access-denied-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
            z-index: 20000;
            justify-content: center;
            align-items: center;
        }

        .ad-modal {
            background: #1a1a1a;
            border: 1px solid #a00000; 
            width: 90%;
            max-width: 450px;
            padding: 0;
            box-shadow: none; 
            animation: adShake 0.4s ease-in-out;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        @keyframes adShake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        .ad-header-bar {
            background: #a00000; 
            color: white;
            padding: 12px 15px;
            font-size: 11px; 
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ad-body-content { padding: 25px; text-align: center; }
        
        .ad-warning-sign {
            font-size: 45px;
            color: #ff0000;
            margin-bottom: 20px;
            display: inline-block;
        }

        .ad-red-label {
            color: #ff0000; 
            display: block;
            margin-bottom: 5px;
            font-size: 10px; 
            text-transform: uppercase;
            font-weight: bold;
        }

        .ad-white-text {
            color: #bbbbbb;
            font-size: 10px;
            text-transform: uppercase;
            margin-bottom: 20px;
            display: block;
        }

        .ad-message-box {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            color: #ff0000; 
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            box-sizing: border-box;
            outline: none;
            margin-bottom: 20px;
            font-size: 12px;
            text-align: center;
            letter-spacing: 1px;
            border-left: 3px solid #ff0000;
        }

        .ad-actions-row { display: flex; gap: 15px; }
        
        .ad-btn {
            flex: 1;
            padding: 12px;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
            font-size: 11px; 
            letter-spacing: 1px;
        }

        .ad-btn-abort { background: #333; color: #ccc; }
        .ad-btn-retry { background: #a00000; color: white; }
        
        /* NEW STYLES FOR GENERAL WARNINGS */
        #networkWarning, #deleteConfirmModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            display: none;
        }

        #networkWarning .system-modal .modal-body, #deleteConfirmModal .system-modal .modal-body {
            padding: 30px; 
            text-align: center; 
            color: #ccc;
        }
        
        #networkWarning .system-modal i, #deleteConfirmModal .system-modal i {
            color: #a00000; /* Faded/darker red icon */
            font-size: 40px; 
            margin-bottom: 15px;
            display: block;
        }

        #networkWarning .system-modal h2, #deleteConfirmModal .system-modal h2 {
            color: #ffffff; 
            letter-spacing: 2px; 
            margin: 0 0 10px 0; 
            font-size: 16px; 
            text-transform: uppercase;
        }
        
        #networkWarning .system-modal p, #deleteConfirmModal .system-modal p {
             font-size: 10px;
             color: #888;
             margin-bottom: 20px;
        }
        
        /* --- UPDATED HOME DASHBOARD STYLES (MODIFIED FOR POPUP) --- */
        .activation-btn {
            background: #000;
            border: 1px solid #a00000;
            color: #a00000;
            padding: 8px 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 10px;
            cursor: pointer;
            margin: 10px 0;
            letter-spacing: 2px;
            transition: 0.3s;
        }

        .activation-btn:hover {
            background: #a00000;
            color: #fff;
            box-shadow: 0 0 10px #a00000;
        }

        .home-dashboard-grid {
            display: none; /* HIDDEN BY DEFAULT */
            /* POPUP STYLE */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 900px;
            background-color: rgba(10, 10, 10, 0.98);
            
            /* --- UPDATED STYLES START: NO RED GLOW + SMOOTH ANIMATION --- */
            border: 1px solid #333; /* Neutral Border */
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.9); /* Deep Shadow (No Red) */
            animation: popupSmoothOpen 0.15s ease-out; /* Smooth Opening Animation */
            /* --- UPDATED STYLES END --- */

            z-index: 5000;
            padding: 20px;
            /* Grid Layout maintained */
            grid-template-columns: 2fr 1fr;
            grid-template-rows: auto;
            gap: 15px;
            border-radius: 4px;
        }

        /* NEW KEYFRAMES FOR SMOOTH POPUP */
        @keyframes popupSmoothOpen {
            from { opacity: 0; transform: translate(-50%, -48%) scale(0.98); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .dash-close-btn {
            grid-column: span 2;
            text-align: right;
            margin-bottom: 5px;
        }

        .dash-close-btn button {
            background: #333;
            border: 1px solid #555;
            color: #ccc;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Consolas', monospace;
            font-size: 9px;
            text-transform: uppercase;
        }
        .dash-close-btn button:hover {
            background: #a00000;
            color: white;
            border-color: #ff0000;
        }

        .dash-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .dash-win-content {
            background: #050505;
            padding: 10px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            font-family: 'DejaVu Sans Mono', monospace; /* UPDATED FONT */
        }

        .dash-map-placeholder {
            width: 100%;
            height: 250px;
            background: 
                linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)),
                url('https://media.istockphoto.com/id/1144604854/vector/fingerprint-scan.jpg?s=612x612&w=0&k=20&c=N5p6KqP1Dk_5vQyVbFqY_X_X5vQyVbFqY_X_X5vQyVbFqY_X=') no-repeat center center;
            background-size: cover;
            border: 1px solid #222;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dash-map-overlay {
            color: #00ff41;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 0 0 5px #00ff41;
            animation: pulseText 2s infinite;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* CODING FONT */
        }

        @keyframes pulseText { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* --- ADDED MEDIA QUERY FOR NETWORK MAP LIST STACKING --- */
        @media (max-width: 600px) {
            #network-map-section .category-container {
                flex: 1 1 100% !important; /* Forces one column on small screens */
            }
        }
        
        /* --- NEW STYLE FOR NETWORK MAP SECTION TO FIX LAYOUT --- */
        #network-map-section {
            display: flex;
            flex-direction: column; /* Stacks children vertically */
        }

        /* --- EXTERNAL VIEWER MODAL STYLE MODIFICATION --- */
        
        /* MODIFIED: Overlay transparency and BLUR REMOVAL - FIX 1 (External View) */
        #externalViewModal.editor-modal-overlay {
            background: rgba(0,0,0,0.05) !important; /* Very low opacity for minimal darkening */
            backdrop-filter: none !important; /* BLUR REMOVAL */
        }
        
        #externalViewModal .editor-modal {
            /* 1. Size change: Max-width 700px, Height 70% of viewport, slightly bigger than commsSmallWindow (500px width) */
            max-width: 600px !important; 
            width: 600px !important; 
            height: 60% !important; 
            padding: 0;
            
            /* 2. Overlap position: Right side, slightly up from the center */
            position: fixed !important;
            top: 20% !important; 
            right: 15px !important; 
            left: unset !important; 
            transform: none !important; 

            /* 3. Background transparency (using a darker shade for readability of modal header/footer) */
            background: #101010; /* Semi-transparent dark background for the modal box itself */
            
            border: 1px solid #333; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            animation: modalSlide 0.3s ease-out; 
            z-index: 5000; 
        }
        
        /* MODIFIED: Modal Body for full background visibility */
        #externalViewModal .editor-modal .modal-body {
            height: calc(100% - 30px) !important; 
            background: transparent; /* Ensure modal body itself is transparent to show iframe/background behind */
            padding: 0;
        }
        
        /* MODIFIED: Ensure iframe fills the entire body and is visible */
        #externalViewModal #externalFrame {
            width: 100%;
            height: 100%;
            border: none;
            background: #000; /* Dark background for the iframe space itself */
        }
        /* --- END EXTERNAL VIEWER MODAL STYLE MODIFICATION --- */

        /* --- NEW STYLES FOR SECURE COMMS TABLE (MATCHING UPLOADED IMAGE) --- */
        .comms-table-wrapper {
            width: 100%;
            background-color: #0b0b0b;
            border: 1px solid #333;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 10px;
            margin-top: 10px;
        }

        /* The Top Tabs (ALL STUDIES, CT BODY...) */
        .comms-table-tabs {
            display: flex;
            background-color: #000;
            border-bottom: 1px solid #333;
            padding: 0;
        }
        .comms-tab {
            padding: 8px 15px;
            color: #888;
            border-right: 1px solid #333;
            cursor: default;
            font-weight: bold;
        }
        .comms-tab.active {
            color: #e0e0e0;
            background: #1a1a1a;
        }

        /* The Table Headers */
        .comms-grid-table {
            width: 100%;
            border-collapse: collapse;
        }
        .comms-grid-table th {
            background-color: #111;
            color: #aaa;
            text-align: left;
            padding: 8px 10px;
            border-bottom: 1px solid #333;
            border-right: 1px solid #222;
            font-weight: normal;
            text-transform: uppercase;
            font-size: 9px;
            letter-spacing: 0.5px;
        }

        /* The Table Rows */
        .comms-grid-table td {
            padding: 6px 10px;
            border-bottom: 1px solid #1a1a1a;
            border-right: 1px solid #1a1a1a;
            color: #ccc;
            cursor: pointer;
            transition: all 0.1s;
        }

        /* Even/Odd Row Styling (Zebra Striping) */
        .comms-grid-table tr:nth-child(even) {
            background-color: #161616;
        }
        .comms-grid-table tr:nth-child(odd) {
            background-color: #0e0e0e;
        }

        /* HOVER EFFECT - THE RED BAR FROM IMAGE */
        .comms-grid-table tr:hover {
            background-color: #d32f2f !important; /* The Red Highlight */
            color: #ffffff !important;
        }
        .comms-grid-table tr:hover td {
            color: #ffffff !important;
            border-color: #d32f2f;
        }

        /* Specific Column Colors before hover */
        .col-id { color: #888; }
        .col-status-v { color: #ccc; }
        .col-status-nv { color: #888; }

        /* Override previous container width to fit the table */
        #secure-comms-section .category-container {
            width: 100% !important;
            max-width: 100% !important;
            padding: 0;
            border: none;
            background: transparent;
        }

        /* --- NEW ANIMATED SIGNAL LOADER STYLES --- */
        .comms-loader {
            position: relative;
            width: 60px;
            height: 60px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .comms-loader i {
            color: #a00000;
            font-size: 24px;
            z-index: 10;
            text-shadow: 0 0 10px rgba(160, 0, 0, 0.5);
        }
        .comms-loader .ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: #a00000;
            border-bottom-color: #a00000;
            animation: spin-ring 2s linear infinite;
        }
        .comms-loader .ring:nth-child(2) {
            width: 70%;
            height: 70%;
            border-color: transparent;
            border-left-color: #ff0000;
            border-right-color: #ff0000;
            animation: spin-ring-reverse 1.5s linear infinite;
        }
        @keyframes spin-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin-ring-reverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body onload="initApp()">

    <!-- NEW: SYSTEM LOCKED POPUP WINDOW -->
    <div id="systemLockedPopup" class="editor-modal-overlay">
        <div class="system-modal" style="border-color: #ff0000;">
            <div class="modal-header" style="background: #a00000;">
                <span><i class="fas fa-lock"></i> SYSTEM ENCRYPTION ACTIVE</span>
                <i class="fas fa-times" onclick="closeLockedPopup()" style="cursor:pointer"></i>
            </div>
            <div class="modal-body" style="text-align: center;">
                <i class="fas fa-user-lock" style="font-size: 50px; color: #ff0000; margin-bottom: 20px;"></i>
                <h2 style="color: #ff0000; letter-spacing: 2px;">ACCESS RESTRICTED</h2>
                <p style="color: #ccc; margin-bottom: 5px;">ROOT PRIVILEGES REQUIRED FOR THIS ACTION.</p>
                <p style="color: #888; font-size: 10px; margin-bottom: 25px;">PLEASE ACTIVATE "GLOBAL_NET_ACTIVITY.EXE" IN THE TERMINAL.</p>
                <div class="modal-actions">
                    <button class="modal-btn btn-cancel" onclick="closeLockedPopup()">CANCEL</button>
                    <button class="modal-btn btn-confirm" style="background: #a00000;" onclick="toggleDashboard(true); closeLockedPopup();">OPEN TERMINAL</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: NETWORK WARNING POPUP (MODIFIED FOR TECHNICAL LOOK) -->
    <div id="networkWarning" class="editor-modal-overlay">
        <div class="system-modal">
            <div class="modal-header">
                <span><i class="fas fa-satellite-dish"></i> SECURE LINK FAILURE</span>
                <i class="fas fa-times" onclick="hideNetworkWarning()" style="cursor:pointer"></i>
            </div>
            <div class="modal-body">
                <i class="fas fa-broadcast-tower"></i>
                <h2>GRID SYNC PROTOCOL: OFFLINE</h2>
                <p>CRITICAL: SECURE GRID DISCONNECTED. VERIFY LOCAL NETWORK INTEGRITY AND EXECUTE RECONNECT PROTOCOL TO RE-ESTABLISH SECURE LINK.</p>
                <button class="modal-btn btn-confirm" style="background:#ff0000;" onclick="window.location.reload()">INITIATE RECONNECT PROTOCOL</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: DELETE CONFIRMATION POPUP (MODIFIED FOR TECHNICAL LOOK) -->
    <div id="deleteConfirmModal" class="editor-modal-overlay">
        <div class="system-modal">
            <div class="modal-header">
                <span><i class="fas fa-skull-crossbones"></i> CRITICAL: DESTRUCT SEQUENCE INITIATION</span>
                <i class="fas fa-times" onclick="closeDeleteConfirmModal()" style="cursor:pointer"></i>
            </div>
            <div class="modal-body">
                <i class="fas fa-radiation"></i>
                <h2 id="delete-modal-title">AUTHORIZE DATA TERMINATION</h2>
                <p id="delete-modal-message">CRITICAL WARNING: DATA TRACE ERASURE IMMINENT. PROCEEDING WILL PERMANENTLY TERMINATE DATA OBJECT. INITIATE DESTRUCT SEQUENCE?</p>
                <div class="modal-actions">
                    <button class="modal-btn btn-cancel" onclick="closeDeleteConfirmModal()">CANCEL SEQUENCE</button>
                    <button class="modal-btn btn-confirm" id="delete-modal-confirm-btn" style="background:#ff0000;">EXECUTE TERMINATION</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ACCESS DENIED POPUP -->
    <div id="access-denied-popup">
        <div class="ad-modal">
            <div class="ad-header-bar">
                <span><i class="fas fa-shield-alt"></i> SECURITY SYSTEM REJECTION</span>
                <i class="fas fa-times" onclick="closeAdPopup()" style="cursor:pointer"></i>
            </div>
            <div class="ad-body-content">
                <div class="ad-warning-sign">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <span class="ad-red-label">SECURITY VIOLATION DETECTED:</span>
                <span class="ad-white-text">PROTOCOL ERROR: INVALID SECURITY PHRASE</span>
                <div class="ad-message-box">CORE SYSTEM ACCESS: DENIED</div>
                <div class="ad-actions-row">
                    <button class="ad-btn ad-btn-abort" onclick="closeAdPopup()">ABORT</button>
                    <button class="ad-btn ad-btn-retry" onclick="closeAdPopup()">RETRY</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. ENTRY GATE PAGE -->
    <div id="entry-page">
        <div class="entry-glass-box">
            <div class="entry-header">
                <i class="fas fa-shield-halved"></i>
                <span>Secure Node Login</span>
            </div>
            <div class="entry-content">
                <h2>Authorize Access</h2>
                <div class="entry-input-wrapper">
                    <i class="fas fa-terminal"></i>
                    <input type="text" id="initialPhraseInput" placeholder="Enter security phrase...">
                </div>
                <button class="entry-btn" onclick="unlockMainSite()">Verify Authorization</button>
            </div>
        </div>
    </div>

    <!-- WRAPPER FOR MAIN SITE -->
    <div id="main-wrapper">
        <div id="grid-toast">
            <i class="fas fa-shield-alt" style="margin-right: 10px;"></i>
            <span id="toast-msg"></span>
        </div>

        <div id="uploadConfirmModal" class="editor-modal-overlay">
            <div class="editor-modal">
                <div class="modal-header">
                    <span>SECURITY AUTHORIZATION</span>
                    <i class="fas fa-times" onclick="closeConfirmModal()" style="cursor:pointer"></i>
                </div>
                <div class="modal-body">
                    <span class="modal-label">VERIFY TRANSMISSION PROTOCOL:</span>
                    <p style="font-size: 10px; color: #888; margin-top: -5px; margin-bottom: 15px;">ENTER MISSION-CRITICAL SECURITY PHRASE</p>
                    <input type="text" class="modal-input" id="securityPhraseInput" placeholder="Enter security phrase...">
                    <div class="modal-actions">
                        <button class="modal-btn btn-cancel" onclick="closeConfirmModal()">ABORT</button>
                        <button class="modal-btn btn-confirm" onclick="verifySecurityAndUpload()">AUTHORIZE</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW EDIT MODAL FOR LOGS -->
        <div id="editLogModal" class="editor-modal-overlay">
            <div class="editor-modal" style="max-width: 550px;">
                <div class="modal-header">
                    <span>EDIT DATA LOG ENTRY</span>
                    <i class="fas fa-times" onclick="closeEditModal()" style="cursor:pointer"></i>
                </div>
                <div class="modal-body">
                    <span class="modal-label">FILE ID (TOPIC)</span>
                    <input type="text" class="modal-input" id="edit-log-id" placeholder="Enter new File ID...">
                    
                    <span class="modal-label">CATEGORY</span>
                    <!-- NEW CATEGORY DROPDOWN STRUCTURE -->
                    <div class="category-container">
                        <input type="hidden" id="edit-log-category" value="General">
                        <div class="category-trigger" onclick="toggleCustomDropdown('edit-cat-list')" style="border-left: 3px solid #000;">
                            <span id="edit-cat-label">Classification: General</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <ul id="edit-cat-list" class="category-list">
                            <li onclick="selectCategory('edit-log', 'General')">General</li>
                            <li onclick="selectCategory('edit-log', 'Artificial intelligence')">Artificial intelligence</li>
                            <li onclick="selectCategory('edit-log', 'Cybersecurity')">Cybersecurity</li>
                            <li onclick="selectCategory('edit-log', 'Codes')">Codes</li>
                            <li onclick="selectCategory('edit-log', 'Victim')">Victim</li>
                            <li onclick="selectCategory('edit-log', 'Thrate')">Thrate</li>
                            <li onclick="selectCategory('edit-log', 'Report')">Report</li>
                            <li onclick="selectCategory('edit-log', 'Data')">Data</li>
                            <li onclick="selectCategory('edit-log', 'Informations')">Informations</li>
                            <li onclick="selectCategory('edit-log', 'OSINTA')">OSINTA</li>
                            <li onclick="selectCategory('edit-log', 'Lost.dir')">Lost.dir</li>
                            <li onclick="selectCategory('edit-log', 'Log.list')">Log.list</li>
                        </ul>
                    </div>
                    
                    <!-- NEW: URL Input Section for OSINT -->
                    <div id="edit-log-url-section" style="display:none; margin-top: 15px;">
                        <span class="modal-label" style="color: #004d99;"><i class="fas fa-link"></i> URL / EXTERNAL LINK</span>
                        <input type="text" class="modal-input" id="edit-log-url" placeholder="https://external-resource.com or Onion link">
                    </div>
                    
                    <span class="modal-label">DESCRIPTION/CONTENT (Text Only)</span>
                    <textarea class="modal-input" id="edit-log-content" rows="4" style="color: #fff;"></textarea>
                    
                    <div class="modal-actions">
                        <button class="modal-btn btn-cancel" onclick="closeEditModal()">CANCEL</button>
                        <button class="modal-btn btn-confirm" id="edit-save-btn">SAVE CHANGES</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="uploadSuccessModal">
            <div class="success-box">
                <div class="modal-header">
                    <span>Transmission Accomplished</span>
                    <i class="fas fa-times" onclick="closeSuccessModal()" style="cursor:pointer"></i>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <i class="fas fa-check-double" style="font-size: 40px; color: #00ff41; margin-bottom: 20px;"></i>
                    <h2 style="color: #ffffff; letter-spacing: 2px; margin: 0 0 10px 0; font-size: 18px;">INTEL SYNCHRONIZED</h2>
                    <div class="console-log">
                        > HANDSHAKE ESTABLISHED... [OK]<br>
                        > PACKET ENCRYPTION (AES-256)... [OK]<br>
                        > STORAGE NODE: GRID-X08... [OK]<br>
                        > GLOBAL ACCESS GRANTED... [TRUE]
                    </div>
                    <button class="modal-btn btn-confirm" style="width: 100%;" onclick="closeSuccessModal()">ACKNOWLEDGE TRANSMISSION</button>
                </div>
            </div>
        </div>

        <div class="editor-modal-overlay" id="urlModal">
            <div class="editor-modal">
                <div class="modal-header">
                    <span id="modalTitle">Insert Resource</span>
                    <i class="fas fa-times" onclick="closeUrlModal()" style="cursor:pointer"></i>
                </div>
                <div class="modal-body">
                    <span class="modal-label" id="modalLabel">Enter Destination URL:</span>
                    <input type="text" class="modal-input" id="modalInput" placeholder="https://...">
                    <div class="modal-actions">
                        <button class="modal-btn btn-cancel" onclick="closeUrlModal()">Abort</button>
                        <button class="modal-btn btn-confirm" id="modalConfirmBtn">Inject Data</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NEW: EXTERNAL WEBSITE VIEWER MODAL (Big Window with Iframe) -->
        <div id="externalViewModal" class="editor-modal-overlay" style="z-index: 5000;">
            <div class="editor-modal" style="max-width: 90%; width: 900px; height: 90%; padding: 0;">
                <div class="modal-header">
                    <span id="externalViewTitle"><i class="fas fa-globe"></i> EXTERNAL NODE CONNECTION</span>
                    <i class="fas fa-times" onclick="closeExternalViewer()" style="cursor:pointer"></i>
                </div>
                <div class="modal-body" style="padding: 0; height: calc(100% - 30px); display: flex;">
                    <!-- iFrame for the external website -->
                    <iframe id="externalFrame" style="width: 100%; height: 100%; border: none; background: #000;" loading="eager"></iframe>
                </div>
            </div>
        </div>
        <!-- END NEW EXTERNAL VIEWER MODAL -->

        <div class="container">
            <header class="secret-header">
                <div class="header-content">
                    <h1>AlphaVault/X01</h1>
                    <p>Secure & hidden Services | Global Intelligence Network [ESTD-2025]</p>
                </div>
            </header>
            
            <div class="menu-wrapper">
                <button class="menu-toggle" onclick="toggleMenu()">
                    <i class="fas fa-terminal"></i> MENU
                </button>
                <ul id="dropdownMenu" class="dropdown-menu">
                    <li><a onclick="showPage('default-content')">Home</a></li>
                    <li><a onclick="showPage('upload-section')">Uploded NTDATA</a></li> <!-- MODIFIED TEXT -->
                    <li><a onclick="showPage('history-section')">DATA HISTORY</a></li>
                    <li><a onclick="showPage('notebook-section')">notebook [08]</a></li>
                    <li><a onclick="showPage('network-map-section')">Network Map</a></li>
                    <li><a onclick="showPage('secure-comms-section')">Secure Comms</a></li>
                </ul>
            </div>

            <div class="status-bar">
                <span>:: SYSTEM STATUS :: - SECURE <span id="realTimeClock"></span></span>
            </div>

            <main class="content-area" id="main-content">
                
                <div id="default-content">
                    <div class="date">CLASSIFIED DIRECTIVE - 2025.09.25</div>
                    <p>Access to the AlphaVault/X01 secure network has now been fully restored. All personnel are instructed to return to using the designated encrypted communication methods.</p>
                    
                    <!-- !!! NEW ACTIVATION BUTTON !!! -->
                    <button class="activation-btn" onclick="toggleDashboard(true)">[ ACTIVATION STATUS: OFF ]</button>

                    <div class="tech-divider"></div>
                    
                    <!-- !!! NEW BIG WINDOWS DASHBOARD SECTION (POPUP) !!! -->
                    <div class="home-dashboard-grid" id="homeDashboard">
                        
                        <!-- CLOSE BUTTON FOR POPUP -->
                        <div class="dash-close-btn">
                            <button onclick="toggleDashboard(false)">CLOSE TERMINAL [X]</button>
                        </div>

                        <!-- LEFT LARGE WINDOW (REPLACED MAP WITH TERMINAL) -->
                        <div class="win-box" style="grid-row: span 2;">
                            <div class="win-bar">
                                <div class="win-title">GLOBAL_NET_ACTIVITY.EXE</div>
                                <!-- WIN-CONTROLS REMOVED HERE -->
                            </div>
                            <div class="dash-win-content" style="padding:0;">
                                <div id="terminal-console">
                                    <div>Kali GNU/Linux Rolling [Version 2025.1]</div>
                                    <div>(c) Global Security Net. All rights reserved.</div>
                                    <br>
                                    <div>> SYSTEM LOCKED. UPLOAD/EDIT DISABLED.</div>
                                    <div>> ENTER ACTIVATION KEY TO UNLOCK...</div>
                                    <div id="term-output"></div>
                                    <div style="display:flex; margin-top:5px;">
                                        <span style="color:#ff0000; margin-right:5px;" id="term-prompt">root@grid:~/lock#</span>
                                        <input type="text" id="terminal-input" autocomplete="off" onkeydown="handleTerminalCommand(event)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT TOP WINDOW -->
                        <div class="win-box">
                            <div class="win-bar">
                                <div class="win-title">ACTIVE_NODES</div>
                            </div>
                            <div class="dash-win-content">
                                <div class="dash-status-row"><span>PROXY-01</span> <span class="dash-status-val" style="color:#00ff41">ONLINE</span></div>
                                <div class="dash-status-row"><span>PROXY-02</span> <span class="dash-status-val" style="color:#00ff41">ONLINE</span></div>
                                <div class="dash-status-row"><span>PROXY-03</span> <span class="dash-status-val" style="color:#ffbd2e">WARN</span></div>
                                <div class="dash-status-row"><span>PROXY-04</span> <span class="dash-status-val" style="color:#ff0000">OFFLINE</span></div>
                            </div>
                        </div>

                        <!-- RIGHT BOTTOM WINDOW -->
                        <div class="win-box">
                            <div class="win-bar">
                                <div class="win-title">KERNEL_LOG</div>
                                <!-- WIN-CONTROLS REMOVED HERE -->
                            </div>
                            <div class="dash-win-content">
                                <!-- ADDED ID TO THIS SECTION FOR JS MANIPULATION -->
                                <div class="dash-log-text" id="kernel-log-content">
                                    [10:42:01] ROOT ACCESS GRANTED<br>
                                    [10:42:05] DOWNLOADING PACKET...<br>
                                    [10:42:08] ENCRYPTION KEY: VALID<br>
                                    [10:42:15] UPDATING DATABASE...<br>
                                    [10:42:22] <span style="animation: pulseText 1s infinite">WAITING FOR COMMAND_</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- !!! END NEW SECTION !!! -->

                    <p><strong>Operational Guidelines:</strong></p>
                    <ol>
                        <li>Public discussions of operations are prohibited.</li>
                        <li>Only verified devices may be used.</li>
                    </ol>
                </div>
                
                <!-- NEW NETWORK MAP / OSINT SECTION -->
                <div id="network-map-section" style="display:none;">
                    
                    <!-- !!! MODIFIED: Reverting to fixed OSINT list structure to match image !!! -->
                    <div class="date">OSINT [SEARCH ENGINE] CHANNELS</div>
                    <p>Select a search engine for open-source intelligence gathering:</p>
                    
                    <!-- NEW WRAPPER FOR HORIZONTAL LAYOUT -->
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        
                        <!-- 1. OSINT SEARCH ENGINE LIST (Original, max-width removed, flex added) -->
                        <div class="category-container" style="flex: 1 1 280px; min-width: 250px;">
                            <!-- The blue header bar from the image -->
                            <div class="category-trigger" id="osint-list-trigger" style="background: #004d99; border-left: 3px solid #0066cc; border-bottom: 0 !important; cursor: default; pointer-events: none;">
                                <span id="osint-cat-label" style="font-size: 11px; color: white;">OSINT SEARCH ENGINE LIST</span>
                            </div>
                            
                            <!-- The permanent list for OSINT items -->
                            <ul id="network-map-osint-list" class="category-list active map-list-permanent" style="position: relative; max-height: none; border: 1px solid #333; margin-top: 0; box-shadow: none;">
                                <!-- Content will be loaded by JS for OSINT data -->
                                <li style="opacity:0.5; padding: 8px 10px; font-size: 9px; cursor: default; border-top: none; background: transparent;">LOADING OSINT DATA...</li>
                            </ul>
                        </div>
                        
                        <!-- 2. LOST.DIR LIST (NEW) -->
                        <div class="category-container" style="flex: 1 1 280px; min-width: 250px;">
                            <div class="category-trigger" id="lost-dir-list-trigger" style="background: #a00000; border-left: 3px solid #ff0000; border-bottom: 0 !important; cursor: default; pointer-events: none;">
                                <span id="lost-dir-cat-label" style="font-size: 11px; color: white;">LOST.DIR LOGS INDEX</span>
                            </div>
                            <ul id="network-map-lost-dir-list" class="category-list active map-list-permanent" style="position: relative; max-height: none; border: 1px solid #333; margin-top: 0; box-shadow: none;">
                                <!-- Content will be loaded by JS for Lost.dir data -->
                                <li style="opacity:0.5; padding: 8px 10px; font-size: 9px; cursor: default; border-top: none; background: transparent;">LOADING LOST.DIR DATA...</li>
                            </ul>
                        </div>
                        
                        <!-- 3. LOG.LIST LIST (NEW) -->
                        <div class="category-container" style="flex: 1 1 280px; min-width: 250px;">
                            <div class="category-trigger" id="log-list-trigger" style="background: #2a2a2a; border-left: 3px solid #777777; border-bottom: 0 !important; cursor: default; pointer-events: none;">
                                <span id="log-list-cat-label" style="font-size: 11px; color: white;">LOG.LIST DUMP INDEX</span>
                            </div>
                            <ul id="network-map-log-list" class="category-list active map-list-permanent" style="position: relative; max-height: none; border: 1px solid #333; margin-top: 0; box-shadow: none;">
                                <!-- Content will be loaded by JS for Log.list data -->
                                <li style="opacity:0.5; padding: 8px 10px; font-size: 9px; cursor: default; border-top: none; background: transparent;">LOADING LOG.LIST DATA...</li>
                            </ul>
                        </div>
                    </div>
                    <!-- !!! END MODIFIED OSINT LIST STRUCTURE !!! -->


                    <!-- MESSAGE CONTAINER -->
                    <div style="border: 1px solid #333; padding: 20px; background: #0a0a0a; text-align:center; clear: both;">
                        <i class="fas fa-search-dollar" style="font-size: 40px; color: #333; margin-bottom: 10px;"></i>
                        <p style="color: #666; font-size: 10px;">AWAITING NODE/LINK SELECTION...</p>
                    </div>
                </div>
                <!-- END NEW NETWORK MAP / OSINT SECTION -->

                <!-- NEW SECURE COMMS SECTION (MATCHING UPLOADED IMAGE STYLE) -->
                <div id="secure-comms-section" style="display:none;">
                    <div class="date">ENCRYPTED COMM CHANNELS [GRID VIEW]</div>
                    <p>Select a secure frequency from the active study list:</p>
                    
                    <div class="category-container">
                        <input type="hidden" id="comms-category" value="Select Channel">
                        
                        <!-- THE TABLE WRAPPER -->
                        <div class="comms-table-wrapper">
                            <!-- Simulated Tabs Header from Image -->
                            <div class="comms-table-tabs">
                                <div class="comms-tab active">ALL CHANNELS (9)</div>
                                <div class="comms-tab">SECURE (4)</div>
                                <div class="comms-tab">EMERGENCY (2)</div>
                            </div>

                            <table class="comms-grid-table">
                                <thead>
                                    <tr>
                                        <th>CHANNEL NAME</th>
                                        <th>ID CODE</th>
                                        <th>SSN</th>
                                        <th>PROCEDURE</th>
                                        <th>MIDI</th>
                                        <th>IMG</th>
                                        <th>LAST SYNC</th>
                                        <th>STATUS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: SMALL DESKTOP WINDOW (POSITIONED ABSOLUTELY) -->
                <div id="commsSmallWindow" class="win-box">
                    <div class="win-bar">
                        <div class="win-title" id="commsWindowTitle">Channel: N/A</div>
                        <!-- MODIFIED: Changed win-btn to text X for close -->
                        <div class="win-controls">
                            <div style="color: #ff0000; cursor: pointer; font-weight: bold;" onclick="closeCommsWindow()">[X]</div>
                        </div>
                    </div>
                    <div class="win-body" id="commsWindowContent">
                        <!-- Data will load here -->
                    </div>
                </div>

                <!-- NOTEBOOK SECTION -->
                <div id="notebook-section" style="display:none;">
                    <div class="date">SECURE NOTEBOOK TERMINAL [X-08]</div>
                    
                    <div class="category-container">
                        <input type="hidden" id="notebook-category" value="General">
                        <div class="category-trigger" onclick="toggleCustomDropdown('notebook-cat-list')">
                            <span id="notebook-cat-label">Classification: General</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <ul id="notebook-cat-list" class="category-list">
                            <li onclick="selectCategory('notebook', 'General')">General</li>
                            <li onclick="selectCategory('notebook', 'Artificial intelligence')">Artificial intelligence</li>
                            <li onclick="selectCategory('notebook', 'Cybersecurity')">Cybersecurity</li>
                            <li onclick="selectCategory('notebook', 'Codes')">Codes</li>
                            <li onclick="selectCategory('notebook', 'Victim')">Victim</li>
                            <li onclick="selectCategory('notebook', 'Thrate')">Thrate</li>
                            <li onclick="selectCategory('notebook', 'Report')">Report</li>
                            <li onclick="selectCategory('notebook', 'Data')">Data</li>
                            <li onclick="selectCategory('notebook', 'Informations')">Informations</li>
                        </ul>
                    </div>

                    <input type="text" id="notebook-title" placeholder="ENTER NOTE TITLE HERE...">
                    
                    <div class="notebook-container">
                        <div class="editor-toolbar">
                            <button onclick="execCmd('bold')" title="Bold"><i class="fas fa-bold"></i></button>
                            <button onclick="execCmd('italic')" title="Italic"><i class="fas fa-italic"></i></button>
                            <button onclick="execCmd('underline')" title="Underline"><i class="fas fa-underline"></i></button>
                            <button onclick="execCmd('insertUnorderedList')" title="Bullets"><i class="fas fa-list-ul"></i></button>
                            <button onclick="execCmd('insertOrderedList')" title="Numbers"><i class="fas fa-list-ol"></i></button>
                            <button onclick="openCustomPrompt('LINK')" title="Insert Link"><i class="fas fa-link"></i></button>
                            
                            <button onclick="triggerNotebookFileUpload('image')" title="Upload Image"><i class="fas fa-image"></i></button>
                            <button onclick="triggerNotebookFileUpload('video')" title="Upload Video"><i class="fas fa-video"></i></button>
                            <button onclick="triggerNotebookFileUpload('audio')" title="Upload Audio"><i class="fas fa-volume-up"></i></button>
                            
                            <input type="file" id="nb-image-input" accept="image/*" style="display:none" onchange="handleNotebookFile(this, 'image')">
                            <input type="file" id="nb-video-input" accept="video/*" style="display:none" onchange="handleNotebookFile(this, 'video')">
                            <input type="file" id="nb-audio-input" accept="audio/*" style="display:none" onchange="handleNotebookFile(this, 'audio')">

                            <button onclick="execCmd('justifyLeft')"><i class="fas fa-align-left"></i></button>
                            <button onclick="execCmd('removeFormat')" title="Clear"><i class="fas fa-eraser"></i></button>
                            <button onclick="uploadNoteToGrid()" title="Upload to Grid" style="background:#a00000; color:white;"><i class="fas fa-cloud-upload-alt"></i></button>
                            <!-- NEW BUTTON: VIEW HISTORY -->
                            <button onclick="showPage('history-section')" title="View Notebook History" style="background:#2a2a2a;"><i class="fas fa-history"></i> HISTORY</button> 
                            <button onclick="downloadNoteAsPDF()" title="PDF Download" style="background:#2a2a2a;"><i class="fas fa-file-pdf"></i></button>
                            <button onclick="downloadNoteAsTXT()" title="TXT Download" style="background:#2a2a2a;"><i class="fas fa-file-alt"></i></button>
                        </div>
                        <div id="rich-editor" contenteditable="true" spellcheck="false">
                            <p>Write your secure notes here...</p>
                        </div>
                    </div>
                
                    <!-- EXISTING BUILD CATEGORY -->
                    <div id="build-category-wrapper" style="margin-top: 15px; border: 1px dashed #333; padding: 12px; background: rgba(0, 50, 0, 0.1);">
                        <label style="color: #00ff41; font-size: 10px; font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 8px;">
                            <i class="fas fa-hammer"></i> Build New Category Node
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="new-cat-input" placeholder="ENTER NEW CATEGORY NAME..." 
                                   style="flex: 1; background: #000; border: 1px solid #444; border-left: 2px solid #00ff41; color: #fff; padding: 8px 12px; font-family: 'Consolas', monospace; font-size: 11px; outline: none;">
                            
                            <button onclick="buildAndSelectCategory()" 
                                    style="background: #004d99; color: white; border: 1px solid #0066cc; padding: 8px 20px; cursor: pointer; font-family: 'Consolas', monospace; font-size: 11px; text-transform: uppercase; font-weight: bold; letter-spacing: 1px;">
                                <i class="fas fa-plus"></i> BUILD
                            </button>
                        </div>
                        <p style="color: #666; font-size: 9px; margin-top: 5px; margin-bottom: 0;">
                            * Creates a new classification index for immediate data upload.
                        </p>
                    </div>

                    <!-- START: NEW CATEGORY MANAGER (LIST & DELETE) -->
                    <div id="category-manager-wrapper" style="margin-top: 10px; border: 1px solid #333; background: #000;">
                        <div style="background: #1a1a1a; padding: 8px 12px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #a00000; font-weight: bold; font-size: 10px;">ACTIVE CATEGORY DATABASE</span>
                            <button onclick="refreshCategoryManager()" style="background: transparent; border: none; color: #666; cursor: pointer; font-size: 10px;"><i class="fas fa-sync"></i></button>
                        </div>
                        <ul id="manage-cat-list" style="list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto;">
                            <!-- Categories will be loaded here via JS -->
                        </ul>
                    </div>
                    <!-- END: NEW CATEGORY MANAGER -->

                </div>

                <!-- UPLOAD DATA SECTION -->
                <div id="upload-section">
                    <div class="date">SECURE DATA UPLOAD NODE</div>
                    
                    <div class="upload-flex-container">
                        <div class="upload-left-side">
                            <form class="upload-form" id="secureUploadForm">
                                <!-- NEW CATEGORY DROPDOWN -->
                                <label><i class="fas fa-tags"></i> Category</label>
                                <div class="category-container">
                                    <input type="hidden" id="upload-category" value="OSINTA">
                                    <div class="category-trigger" onclick="toggleCustomDropdown('upload-cat-list')">
                                        <span id="upload-cat-label">Classification: OSINTA</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <ul id="upload-cat-list" class="category-list">
                                        <li onclick="selectCategory('upload', 'OSINTA')">OSINTA</li>
                                        <li onclick="selectCategory('upload', 'Lost.dir')">Lost.dir</li>
                                        <li onclick="selectCategory('upload', 'Log.list')">Log.list</li>
                                    </ul>
                                </div>
                                
                                <label><i class="fas fa-id-badge"></i> File ID</label>
                                <input type="text" id="hist_id" placeholder="e.g. ALPHA-02-X" required>
                                
                                <label><i class="fas fa-file-alt"></i> Description</label>
                                <textarea id="hist_desc" rows="3" placeholder="Enter secure intel details..."></textarea>
                                
                                <!-- NEW URL INPUT -->
                                <label><i class="fas fa-link"></i> URL (Optional for OSINTA/Lost.dir)</label>
                                <input type="text" id="hist_url" placeholder="https://external-resource.com or Onion link">

                                <!-- REMOVED FILE UPLOAD ELEMENTS -->
                                
                                <div id="fileNames" style="font-size: 0.8em; color: #00ff41; margin-bottom: 15px; font-weight: bold;"></div>
                                <button type="submit" class="btn-submit" id="mainSubmitBtn">
                                    <i class="fas fa-lock"></i> Initialize Transmission
                                </button>
                                <div class="progress-container" id="progContainer" style="display:none;"><div class="progress-bar" id="progBar" style="width: 0%;"></div></div>
                            </form>
                        </div>

                        <div class="upload-right-side">
                            <div class="win-box">
                                <div class="win-bar">
                                    <div class="win-title">Node_Console.exe</div>
                                    <!-- WIN-CONTROLS REMOVED HERE -->
                                </div>
                                <div class="win-body">
                                    > SYSTEM STATUS: ONLINE<br>
                                    > UPLOAD BUFFER: READY<br>
                                    > ENCRYPTION: AES-256 BIT<br>
                                    > LOCATION: HIDDEN_GRID_08<br>
                                    > -------------------------<br>
                                    > Awaiting secure packets.<br>
                                    > All transmissions are logged.<br>
                                    > IP Trace protection active.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SUCCESS SECTION -->
                    <div id="successSection" class="success-card">
                        <div class="success-layout-wrapper">
                            <img id="uploadImgPreview" class="small-preview" alt="Preview">
                            <div style="flex-grow: 1;">
                                <div class="result-bar bar-wide" id="res-id">File ID</div>
                                <div class="result-bar bar-wide bar-description" id="res-desc">Description</div>
                            </div>
                        </div>
                        <div class="result-bar bar-short" id="res-size">Size</div>
                        <div class="result-bar bar-short" id="res-date">Date</div>
                        <div class="result-bar bar-short" id="res-time">Time</div>
                        <button onclick="resetUploadForm()" class="btn-submit" style="margin-top: 20px; background: #333333; border: 1px solid #555555; color: #bbbbbb;">
                            <i class="fas fa-plus-circle"></i> UPLOAD NEW DATA
                        </button>
                    </div>
                </div>

                <!-- DATA HISTORY -->
                <div id="history-section">
                    <div class="history-header-bar">
                        <h2>DATA LOGS HISTORY</h2>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th style="width: 18%;">PATIENT NAME</th>
                                    <th style="width: 10%;">PATIENT ID</th>
                                    <th style="width: 5%;">SSN</th> 
                                    <th style="width: 15%;">PROCEDURE</th>
                                    <th style="width: 8%;">MIDI</th>
                                    <th style="width: 25%;">ACTIONS</th> <!-- MODIFIED COLUMN TO ACTIONS -->
                                    <th style="width: 12%;">STUDY TIME</th>
                                    <th style="width: 7%;">STATUS</th>
                                </tr>
                            </thead>
                            <tbody id="history-body"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <!-- FOOTER REMOVED -->

    </div>

    <script>
        let globalLogData = []; 
        let globalSystemActive = false; 
        let authStep = 0; 
        let currentEditingDocId = null; // New variable for edit modal doc ID
        let currentNotebookDocId = null; // FIX: Track the currently loaded notebook entry's doc ID
        let osintDataSeeded = false; // Flag to prevent re-seeding

        // OSINT Data Array for seeding
        const osintLinks = [
            { id: "Ahmia Search", url: "https://ahmia.fi/", content: "A deep web search engine that indexes Tor hidden services." },
            { id: "Haystack Search", url: "", content: "Dark web search engine (offline reference)." },
            { id: "Tor66 Search", url: "https://tor66.net/", content: "Tor search engine for .onion sites." },
            { id: "Torch Search", url: "http://xmh57jrknzkhv6y3ls3ubitzfqnkrwxhopf5aygthi7d6rplyvk3noyd.onion/cgi-bin/omega/omega", content: "Original Tor Search Engine." },
            { id: "Onion Search", url: "", content: "General Onion reference (offline reference)." },
            { id: "Telemetry Ref", url: "", content: "Darknet telemetry source (offline reference)." },
            { id: "Library of Leaks", url: "https://search.libraryofleaks.org/", content: "Searchable database for leaked documents." },
            { id: "Haveibeen Pwned", url: "https://haveibeenpwned.com/", content: "Check if your email or phone is in a data breach." },
            { id: "DeHashed DB", url: "https://dehashed.com/", content: "Data breach and credential lookup service." },
            { id: "Leak OSINT", url: "https://leakosint.com/en", content: "Aggregator for data breach information." },
            { id: "Universal Search Bot", url: "https://sites.google.com/view/universal-search-bot/", content: "Comprehensive OSINT resource list." },
            { id: "Darkweblive Status", url: "https://darkwebdaily.live/", content: "Dark web status and news monitoring." },
            { id: "DeepDarkCTI Index", url: "https://deepdarkcti.com/", content: "Cyber Threat Intelligence from deep/dark web." },
            { id: "Onion.live Index", url: "https://onion.live", content: "A directory of onion sites." },
            { id: "Tor.link Index", url: "https://tor.link/", content: "Another Tor link directory." },
            { id: "The Hidden wiki", url: "http://6nhmgdpnyoljh5uzr5kwlatx2u3diou4ldeommfxjz3wkhalzgjqxzqd.onion/", content: "Original uncensored directory." },
            { id: "ProPublica", url: "https://www.propublica.org/", content: "Non-profit investigative journalism." },
            { id: "SecureDrop", url: "https://securedrop.org/", content: "Open-source whistleblower submission system." },
            { id: "Riseup", url: "https://riseup.net/", content: "Activist and privacy-focused email/VPN services." },
            { id: "Tor Metrics", url: "https://metrics.torproject.org/", content: "Statistics on Tor network usage." },
            { id: "Tor Crawl.py Ref", url: "", content: "Automated Tor crawler (offline reference)." },
            { id: "Aleph Search", url: "", content: "Investigative data project (offline reference)." },
            { id: "Tor2web Gateway", url: "https://www.tor2web.org/", content: "Service to access .onion links via normal browser." },
            { id: "PGPTool", url: "https://pgptool.net/", content: "Online PGP encryption tool." },
            { id: "Not Evil Search", url: "https://onion.live/site/not-evil", content: "Tor search engine." },
            { id: "TorDex Index", url: "https://tordex.cc/", content: "Tor search and directory." },
            { id: "DarkSearch Engine", url: "https://darknetsearch.com/", content: "Dark web search engine." }
        ];

        // --- FIREBASE SYNC FUNCTIONS ---
        function initApp() {
            updateStatusTime();
            loadLogsFromFirebase(); 
            setupNetworkListener(); // NEW: Setup network status check
            seedOsintData(); // NEW: Initial data seeding
        }
        
        // NEW: Function to seed the OSINT data
        function seedOsintData() {
            if (localStorage.getItem('osintDataSeeded') === 'true') {
                return; 
            }

            // --- START: Duplicate removal on seeding ---
            const seenIds = new Set();
            const uniqueOsintLinks = [];
            osintLinks.forEach(item => {
                if (!seenIds.has(item.id)) {
                    seenIds.add(item.id);
                    uniqueOsintLinks.push(item);
                }
            });
            // --- END: Duplicate removal on seeding ---
            
            // Use the de-duplicated array for seeding
            uniqueOsintLinks.forEach(item => {
                db.collection("silentgrid_logs").add({
                    id: item.id,
                    category: "OSINTA",
                    content: item.content,
                    fileUrl: item.url, // Using fileUrl to store the URL/Link
                    fileName: item.id,
                    fileType: "link/osint",
                    fileSize: 0,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(err => {
                    console.error("Error adding OSINT doc: ", item.id, err);
                });
            });

            // Seed placeholder Lost.dir and Log.list entries for display demonstration
            const demoLogs = [
                { id: "LOST-001-BOOT", category: "Lost.dir", content: "Unresolved boot trace data.", fileUrl: "", fileType: "text/data" },
                { id: "LOG-SYSTEM-22A", category: "Log.list", content: "System access log dump.", fileUrl: "", fileType: "text/data" },
                { id: "LOST-002-MEM", category: "Lost.dir", content: "Corrupted memory dump file.", fileUrl: "", fileType: "text/data" },
                { id: "LOG-AUTH-B1C", category: "Log.list", content: "Authentication attempts list.", fileUrl: "", fileType: "text/data" }
            ];

            demoLogs.forEach(item => {
                // Check if a similar item exists to prevent re-adding on every seed call (simple check, relies on ID not being a real unique key)
                 db.collection("silentgrid_logs").where("id", "==", item.id).get().then(snapshot => {
                    if (snapshot.empty) {
                        db.collection("silentgrid_logs").add({
                            id: item.id,
                            category: item.category,
                            content: item.content,
                            fileUrl: item.url, 
                            fileName: item.id,
                            fileType: item.fileType,
                            fileSize: 0,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }).catch(err => {
                            console.error("Error adding demo doc: ", item.id, err);
                        });
                    }
                });
            });
            
            localStorage.setItem('osintDataSeeded', 'true');
            showGridToast("OSINT DATA SEEDING COMPLETE");
        }
        // ... (rest of initApp remains the same)

        // NEW: Network Status Listener (Restored as per previous code)
        function setupNetworkListener() {
            window.addEventListener('offline', () => {
                document.getElementById('networkWarning').style.display = 'flex';
            });
            window.addEventListener('online', () => {
                hideNetworkWarning();
            });
            // Initial check
            if (!navigator.onLine) {
                document.getElementById('networkWarning').style.display = 'flex';
            }
        }
        
        function hideNetworkWarning() {
            document.getElementById('networkWarning').style.display = 'none';
        }

        // Real file download helper (Modified to handle URL/File based on fileUrl existence)
        function downloadFile(url, filename) {
            if(!url) { showGridToast("ERROR: NO DATA LINK"); return; }
            if (url.startsWith('http')) {
                // Treat as an external link for OSINT
                window.open(url, '_blank');
                showGridToast("EXTERNAL LINK OPENED: " + filename.toUpperCase());
            } else {
                // Old file download logic (kept for completeness, though not possible with new upload form)
                fetch(url)
                    .then(response => response.blob())
                    .then(blob => {
                        const blobUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(blobUrl);
                        document.body.removeChild(a);
                        showGridToast("SECURED: " + filename.toUpperCase());
                    })
                    .catch(() => showGridToast("DOWNLOAD ERROR"));
            }
        }
        
        // --- FUNCTION: DOWNLOAD TEXT CONTENT (FIXED to use docId and allow raw HTML/Code download) ---
        function downloadContent(docId) { // Changed parameter to docId
            const entry = globalLogData.find(item => item.docId === docId);
            const content = entry ? entry.content : null;
            const filename = entry ? entry.id : 'download';

            if (!content) {
                showGridToast("ERROR: NO TEXT CONTENT TO DOWNLOAD");
                return;
            }
            
            // FIX: Uses raw content for downloading HTML/Code.
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename + "_content.txt");
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            showGridToast("CONTENT DOWNLOADED: " + filename);
        }
        // --- END DOWNLOAD TEXT FUNCTION ---

        // --- NEW: SYSTEM LOCKED POPUP LOGIC ---
        function showLockedPopup() {
            document.getElementById('systemLockedPopup').style.display = 'flex';
        }

        function closeLockedPopup() {
            document.getElementById('systemLockedPopup').style.display = 'none';
        }
        // --- END SYSTEM LOCKED POPUP LOGIC ---

        // --- NEW: DELETE CONFIRMATION LOGIC ---
        let pendingDeleteData = null;
        
        function openDeleteConfirmModal(docId, fileUrl, itemId) {
            if (!globalSystemActive) { 
                showLockedPopup(); // REPLACED: Toast with Popup
                return; 
            }
            
            pendingDeleteData = { docId, fileUrl };
            document.getElementById('delete-modal-title').innerText = `AUTHORIZE DATA TERMINATION: ${itemId}`;
            
            document.getElementById('delete-modal-confirm-btn').onclick = function() {
                executeDelete(pendingDeleteData.docId, pendingDeleteData.fileUrl);
                closeDeleteConfirmModal();
            };
            
            document.getElementById('deleteConfirmModal').style.display = 'flex';
        }
        
        function closeDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            pendingDeleteData = null;
        }

        function executeDelete(docId, fileUrl) {
            // 1. Delete file from Storage (if fileUrl exists and is a Firebase URL)
            if (fileUrl && fileUrl.includes("firebasestorage.googleapis.com")) {
                try {
                    const fileRef = storage.refFromURL(fileUrl);
                    fileRef.delete().then(() => {
                        showGridToast(`STORAGE: File Deleted (${docId})`);
                    }).catch((err) => {
                        showGridToast(`STORAGE WARNING: Could not delete file: ${err.code}`);
                    });
                } catch (e) {
                    showGridToast("STORAGE ERROR: Invalid file reference for deletion.");
                }
            }

            // 2. Delete document from Firestore
            db.collection("silentgrid_logs").doc(docId).delete().then(() => {
                showGridToast("TRANSMISSION DELETED: " + docId);
            }).catch((err) => {
                showGridToast("DELETE ERROR: " + err.message);
            });
        }
        // --- END DELETE LOGIC ---
        
        function deleteLog(docId, fileUrl, itemId) { // FIX: Renamed old deleteLog to openDeleteConfirmModal for consistency
            openDeleteConfirmModal(docId, fileUrl, itemId);
        }
        
        function closeEditModal() {
            document.getElementById('editLogModal').style.display = 'none';
            currentEditingDocId = null;
        }

        // --- MODIFIED: openEditModal to include dropdown and URL field logic ---
        function openEditModal(docId) { // Changed parameters to only docId
            if (!globalSystemActive) { 
                showLockedPopup(); // REPLACED: Toast with Popup
                return; 
            }
            
            const entry = globalLogData.find(item => item.docId === docId);
            if(!entry) { showGridToast("ERROR: Data not found for editing."); return; }

            currentEditingDocId = docId;
            document.getElementById('edit-log-id').value = entry.id;
            
            // Set the dropdown value and label
            const category = entry.category || 'General';
            document.getElementById('edit-log-category').value = category;
            document.getElementById('edit-cat-label').innerText = 'Classification: ' + category;
            
            // Show/Hide URL section and populate URL if available
            const urlSection = document.getElementById('edit-log-url-section');
            const urlInput = document.getElementById('edit-log-url');
            
            if (category === 'OSINTA' || category === 'Lost.dir' || category === 'Log.list') {
                urlSection.style.display = 'block';
                urlInput.value = entry.fileUrl || '';
            } else {
                urlSection.style.display = 'none';
                urlInput.value = ''; // Clear just in case
            }
            
            // Load the raw content/HTML string into the textarea for editing.
            document.getElementById('edit-log-content').value = entry.content;
            
            document.getElementById('editLogModal').style.display = 'flex';
            
            // Set up the save button action
            document.getElementById('edit-save-btn').onclick = function() {
                saveEdit(docId);
            };
        }

        // --- MODIFIED: saveEdit to save URL if visible ---
        function saveEdit(docId) {
            const newId = document.getElementById('edit-log-id').value;
            const newCategory = document.getElementById('edit-log-category').value;
            
            const originalEntry = globalLogData.find(item => item.docId === docId);
            let newContent = document.getElementById('edit-log-content').value;
            
            let newFileUrl = originalEntry.fileUrl; 
            const urlInput = document.getElementById('edit-log-url');

            // Get URL if visible and applicable
            if (newCategory === 'OSINTA' || newCategory === 'Lost.dir' || newCategory === 'Log.list') {
                newFileUrl = urlInput.value.trim();
            } else if (originalEntry.category === 'OSINTA' || originalEntry.category === 'Lost.dir' || originalEntry.category === 'Log.list') {
                // If it was an OSINT/Log/Lost.dir entry but is being changed to a regular category, clear the URL
                 newFileUrl = '';
            }
            
            // If it was a Notebook entry, convert line breaks to <br> to preserve formatting in rich-editor when re-opened
            if (originalEntry && !originalEntry.fileUrl && newContent.includes('\n')) {
                newContent = newContent.replace(/\n/g, '<br>');
            } 
            
            if (!newId) { showGridToast("ERROR: File ID cannot be empty."); return; }

            // Update the Firestore document
            db.collection("silentgrid_logs").doc(docId).update({
                id: newId,
                category: newCategory,
                content: newContent, // This now saves the raw text or raw code
                fileUrl: newFileUrl // Save the updated or cleared URL
            }).then(() => {
                showGridToast("DATA LOG UPDATED: " + newId);
                closeEditModal();
            }).catch((err) => {
                showGridToast("UPDATE ERROR: " + err.message);
            });
        }
        // --- END MODIFIED JS ---


        // --- UPDATED MAIN LOAD FUNCTION (FIXED to pass short doc.id instead of huge content string) ---
        function loadLogsFromFirebase() {
            db.collection("silentgrid_logs").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                const table = document.getElementById('history-body');
                table.innerHTML = ""; 
                globalLogData = [];   
                
                let latestNote = null; // Track latest Notebook entry

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const dateObj = data.timestamp ? data.timestamp.toDate() : new Date();
                    
                    // REMOVED: const contentForArg = data.content ? data.content.replace(/'/g, "\\'") : '';

                    const logEntry = {
                        docId: doc.id, // Store doc ID for delete/edit
                        id: data.id,
                        category: data.category,
                        content: data.content,
                        fileUrl: data.fileUrl,
                        fileName: data.fileName, // Added fileName for better download name
                        fileType: data.fileType, // Ensure fileType is saved
                        date: dateObj
                    };
                    globalLogData.push(logEntry);
                    
                    // Identify the latest Notebook entry
                    if (!data.fileUrl && data.content && data.category !== 'OSINTA' && data.category !== 'Lost.dir' && data.category !== 'Log.list') { // Check if it's a Notebook entry (no fileUrl, has content, not a new category)
                        if (!latestNote || dateObj > latestNote.date) {
                            latestNote = { ...logEntry, date: dateObj };
                        }
                    }


                    const row = document.createElement('tr');
                    
                    // =========================================================================
                    // MODIFIED: ACTIONS BUTTON GENERATION REMOVED (REPLACED WITH PLACEHOLDER)
                    // =========================================================================
                    // Previous buttons (Download, Edit, Delete) logic has been removed here.
                    
                    const actionButtons = `<span style="opacity:0.3; cursor:default; font-size:9px;">---</span>`;
                    
                    // =========================================================================
                    // END: ACTIONS BUTTON MODIFICATION
                    // =========================================================================

                    
                    // Placeholder values for the new columns
                    const dummySSN = Math.floor(Math.random() * 9000) + 1000;
                    const dummyMIDI = 'CT'; 
                    const dateString = `${dateObj.getFullYear()}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}-${dateObj.getDate().toString().padStart(2, '0')}`;


                    row.innerHTML = `
                        <!-- 1. PATIENT NAME -->
                        <td><div class="col-topic"><span class="status-circle status-verified"></span><span>${data.id}</span></div></td>
                        
                        <!-- 2. PATIENT ID - MODIFIED COLOR TO BLUE -->
                        <td style="color:#569cd6; font-weight:bold;">${doc.id.substring(0,6).toUpperCase()}</td> 

                        <!-- 3. SSN -->
                        <td style="color:#aaa;">${dummySSN}</td>

                        <!-- 4. PROCEDURE (Category) -->
                        <td><span class="col-category">${data.category}</span></td>

                        <!-- 5. MIDI (Placeholder) -->
                        <td style="color:#888;">${dummyMIDI}</td>

                        <!-- 6. ACTIONS (The new column with placeholder) -->
                        <td style="white-space: nowrap;">${actionButtons}</td>

                        <!-- 7. STUDY TIME (Date) -->
                        <td style="color:#888;">${dateString}</td>
                        
                        <!-- 8. STATUS - MODIFIED COLOR TO BLUE -->
                        <td style="color:#569cd6; font-weight:bold; font-size:10px;">VERIFIED</td>
                    `;
                    table.appendChild(row);
                });
                
                // Load latest note content into the Notebook editor
                if (latestNote) {
                    currentNotebookDocId = latestNote.docId; 
                    document.getElementById('notebook-title').value = latestNote.id;
                    document.getElementById('notebook-category').value = latestNote.category;
                    document.getElementById('notebook-cat-label').innerText = 'Classification: ' + latestNote.category;
                    document.getElementById('rich-editor').innerHTML = latestNote.content;
                } else if (!currentNotebookDocId) {
                    // Ensure defaults are set if no notes exist
                    document.getElementById('notebook-title').value = "";
                    document.getElementById('rich-editor').innerHTML = "<p>Write your secure notes here...</p>";
                }

                // NEW: Update Network Map lists after load 
                if (document.getElementById('network-map-section').style.display === 'block') {
                    renderOsintList();
                }

                // NEW: Update Secure Comms Table & Category Manager when data loads
                updateSecureCommsTable();
            });
        }
        
        // --- NEW FUNCTION: Render Dedicated Map Lists (REPLACING OLD renderOsintList LOGIC) ---
        function renderMapLists(category, listId, triggerId, headerText) {
            const listElement = document.getElementById(listId);
            if (!listElement) return;

            listElement.innerHTML = ''; // Clear previous content
            
            // Filter ONLY for the specified category
            const filteredData = globalLogData.filter(item => item.category === category);
            
            // --- START: Duplicate removal logic (by ID) ---
            const seenIds = new Set();
            const uniqueData = [];
            
            filteredData.forEach(item => {
                if (!seenIds.has(item.id)) {
                    seenIds.add(item.id);
                    uniqueData.push(item);
                }
            });
            // --- END: Duplicate removal logic ---

            
            if (uniqueData.length === 0) {
                listElement.innerHTML = `<li style="opacity:0.5; padding: 12px 15px; font-size: 9px; cursor: default; border-top: 1px solid #222;">NO ${category.toUpperCase()} NODES FOUND.</li>`;
                return;
            }

            // Use uniqueData for rendering
            uniqueData.forEach(item => {
                // Determine logo source (using first two letters of the ID)
                const logoName = item.id.substring(0, 2).toUpperCase();
                let logoColor, borderColor, hoverBg;
                
                if (category === 'OSINTA') {
                    logoColor = '004d99'; 
                    borderColor = '#004d99'; 
                    hoverBg = '#0066cc';
                } else if (category === 'Lost.dir') {
                    logoColor = 'a00000';
                    borderColor = '#ff0000';
                    hoverBg = '#2a0000';
                } else if (category === 'Log.list') {
                    logoColor = '2a2a2a';
                    borderColor = '#777777';
                    hoverBg = '#444444';
                } else {
                    logoColor = '111';
                    borderColor = '#333';
                    hoverBg = '#2a0000';
                }
                
                const logoSrc = `https://ui-avatars.com/api/?name=${logoName}&background=${logoColor}&color=fff&rounded=true`;

                const listItem = document.createElement('li');
                // Use the OSINT selection function which reuses the small comms window logic
                listItem.setAttribute('onclick', `selectOsint('${item.id}', '${item.fileUrl || ''}', event, '${item.category}')`);
                listItem.style.borderTop = '1px solid #222';

                // Apply specific hover styles 
                listItem.onmouseover = function() { this.style.backgroundColor = hoverBg; this.style.paddingLeft = '20px'; this.style.color = '#ffffff'; };
                listItem.onmouseout = function() { this.style.backgroundColor = 'transparent'; this.style.paddingLeft = '15px'; this.style.color = '#ffffff'; }; 

                listItem.innerHTML = `
                    <div class="comms-option">
                        <img src="${logoSrc}" class="comms-logo" alt="logo" style="border-color: ${borderColor};">
                        <span style="font-size: 10px;">${item.id}</span>
                    </div>
                `;
                listElement.appendChild(listItem);
            });
            
            // Ensure the list items have correct default padding
            const listItems = listElement.querySelectorAll('li');
            listItems.forEach(li => {
                li.style.padding = '12px 15px'; // Adjust to fit the default li padding
            });
        }
        
        // --- MODIFIED FUNCTION: renderOsintList (Now the main map list renderer) ---
        function renderOsintList() {
            // 1. OSINTA List
            renderMapLists('OSINTA', 'network-map-osint-list', 'osint-list-trigger', 'OSINT SEARCH ENGINE LIST');
            
            // 2. Lost.dir List (New)
            renderMapLists('Lost.dir', 'network-map-lost-dir-list', 'lost-dir-list-trigger', 'LOST.DIR LOGS INDEX');

            // 3. Log.list List (New)
            renderMapLists('Log.list', 'network-map-log-list', 'log-list-trigger', 'LOG.LIST DUMP INDEX');
        }
        
        // --- OLD FUNCTION: Keeping the empty shell, calling the new function. ---
        function displayNetworkMapLists() {
            // Initialization for Network Map view now just calls the dedicated OSINT rendering function
            renderOsintList();
        }
        // --- END NEW/MODIFIED FUNCTION ---


        // --- NEW FUNCTION: LOAD NOTEBOOK ENTRY ---
        function loadNotebookEntry(docId) {
            const entry = globalLogData.find(item => item.docId === docId);
            if (entry) {
                currentNotebookDocId = entry.docId; // FIX: Set current doc ID when loading from history for proper updating
                document.getElementById('notebook-title').value = entry.id;
                document.getElementById('notebook-category').value = entry.category;
                document.getElementById('notebook-cat-label').innerText = 'Classification: ' + entry.category;
                document.getElementById('rich-editor').innerHTML = entry.content; // Load rich content
                showPage('notebook-section');
                showGridToast("NOTEBOOK: Entry loaded - " + entry.id);
            } else {
                showGridToast("ERROR: Notebook Entry not found in cache.");
            }
        }
        // --- END NEW FUNCTION ---

        function toggleDashboard(show) {
            const dash = document.getElementById('homeDashboard');
            if(show) { dash.style.display = 'grid'; } 
            else { dash.style.display = 'none'; }
        }

        function runKernelCodes() {
            const logBox = document.getElementById('kernel-log-content');
            logBox.innerHTML = ""; 
            const logs = [
                "INITIATING GLOBAL UNLOCK SEQUENCE...",
                "VERIFYING USER 'Rohit'...",
                "SECONDARY KEY 'nex/001' ACCEPTED...",
                "DECRYPTING UPLOAD MODULES...",
                "BYPASSING FIREWALL (LAYER 4)...",
                "CONNECTING TO SECURE CLOUD NODES...",
                "AUTHENTICATION TOKEN: VERIFIED",
                "ACCESS TO DATABASE: GRANTED",
                "SYSTEM: ONLINE - READY FOR COMMAND"
            ];

            let delay = 0;
            logs.forEach(line => {
                setTimeout(() => {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-GB'); 
                    logBox.innerHTML += `<div>[${timeString}] ${line}</div>`;
                    logBox.scrollTop = logBox.scrollHeight;
                }, delay);
                delay += Math.floor(Math.random() * 500) + 400; 
            });
        }

        function handleTerminalCommand(event) {
            if(event.key === 'Enter') {
                const input = document.getElementById('terminal-input');
                const output = document.getElementById('term-output');
                const val = input.value.trim();
                const currentPrompt = document.getElementById('term-prompt').innerText;
                output.innerHTML += `<div>${currentPrompt} ${val}</div>`;
                
                if(val === "clear") { output.innerHTML = ""; } 
                else if (authStep === 0) {
                    if (val === "Rohit") {
                        authStep = 1;
                        output.innerHTML += `<div style="color:#ffbd2e;">> USER IDENTIFIED. ENTER SECONDARY KEY...</div>`;
                    } else { output.innerHTML += `<div style="color:#ff0000;">> ACCESS DENIED: INVALID USER</div>`; }
                } 
                else if (authStep === 1) {
                    if (val === "nex/001") {
                        globalSystemActive = true;
                        authStep = 2; 
                        output.innerHTML += `<div style="color:#00ff41;">> ACCESS GRANTED: all are nex</div>`;
                        output.innerHTML += `<div style="color:#00ff41;">> GLOBAL UPLOAD PROTOCOLS UNLOCKED.</div>`;
                        document.getElementById('term-prompt').innerText = "root@grid:~#";
                        document.getElementById('term-prompt').style.color = "#00ff41";
                        showGridToast("SYSTEM UNLOCKED: UPLOADS ENABLED");
                        runKernelCodes();
                    } else {
                        authStep = 0; 
                        output.innerHTML += `<div style="color:#ff0000;">> ACCESS DENIED: WRONG KEY. RESETTING...</div>`;
                    }
                } 
                else { output.innerHTML += `<div style="color:#aaa;">> COMMAND RECEIVED (System Active).</div>`; }
                input.value = "";
                document.getElementById('terminal-console').scrollTop = document.getElementById('terminal-console').scrollHeight;
            }
        }

        function toggleCustomDropdown(id) {
            const list = document.getElementById(id);
            const allLists = document.querySelectorAll('.category-list');
            // The OSINT list is permanent, so we only close non-map dropdowns that are currently active.
            
            // NOTEBOOK / UPLOAD / EDIT DROPDOWNS:
            allLists.forEach(l => { 
                if(l.id !== 'network-map-osint-list' && l.id !== 'network-map-lost-dir-list' && l.id !== 'network-map-log-list' && l.id !== 'comms-cat-list') l.classList.remove('active'); 
            });
            // If the element clicked is not the fixed OSINT list, toggle it
            if (id !== 'network-map-osint-list' && id !== 'network-map-lost-dir-list' && id !== 'network-map-log-list') {
                list.classList.toggle('active');
            }
        }

        // --- MODIFIED: selectCategory to handle dynamic URL field in Edit Modal ---
        function selectCategory(type, value) {
            const categoryInput = document.getElementById(type + '-category');
            const label = document.getElementById(type + '-cat-label');
            const list = document.getElementById(type + '-cat-list');
            const urlSection = document.getElementById('edit-log-url-section');
            
            categoryInput.value = value;
            label.innerText = (type === 'network-map' ? 'Selected Category: ' : 'Classification: ') + value;
            if (list) list.classList.remove('active');

            // Handle visibility of the URL field ONLY for the edit modal
            if (type === 'edit-log') {
                if (value === 'OSINTA' || value === 'Lost.dir' || value === 'Log.list') {
                    urlSection.style.display = 'block';
                } else {
                    urlSection.style.display = 'none';
                    document.getElementById('edit-log-url').value = ''; // Clear URL when switching away
                }
            }
        }
        
        function selectComms(category, event) {
            event.stopPropagation(); 
            document.getElementById('comms-category').value = category;
            openCommsWindow(category, event.currentTarget);
        }

        // --- NEW FUNCTION: Select OSINT and open small window (Reused for all Map Lists) ---
        function selectOsint(name, url, event, category) { // **MODIFIED: Added category parameter**
            event.stopPropagation(); 
            // Removed updating network-map-category since it no longer exists in a meaningful context here.
            openOsintWindow(name, url, event.currentTarget, category); // **MODIFIED: Passed category**
        }

        // --- NEW FUNCTION: Open External Viewer (Big Window with Iframe) ---
        function openExternalViewer(url, name) {
            const modal = document.getElementById('externalViewModal');
            const iframe = document.getElementById('externalFrame');
            const titleSpan = document.getElementById('externalViewTitle');

            if (!url || url === 'N/A (ONION/CLOSED NETWORK)') {
                showGridToast("ERROR: CANNOT EXECUTE OFFLINE/INVALID QUERY");
                return;
            }
            
            // Close the small window first (if it was open)
            // closeCommsWindow(); // **REMOVED THIS LINE as per the user's request**

            // Set content
            titleSpan.innerHTML = `<i class="fas fa-globe"></i> EXTERNAL NODE CONNECTION: ${name.toUpperCase()}`;
            // NOTE: Many websites block loading in an iframe (X-Frame-Options), but this is the requested method.
            iframe.src = url; 

            // Display the big modal
            modal.style.display = 'flex';
            showGridToast(`CONNECTING TO EXTERNAL NODE: ${name}`);
        }

        function closeExternalViewer() {
            const modal = document.getElementById('externalViewModal');
            const iframe = document.getElementById('externalFrame');
            iframe.src = 'about:blank'; // Clear iframe content
            modal.style.display = 'none';
        }
        // --- END NEW FUNCTIONS ---
        
        // --- MODIFIED FUNCTION: Open OSINT Window (reusing commsSmallWindow) ---
        function openOsintWindow(name, url, triggerElement, category) { // **MODIFIED: Added category parameter**
            const win = document.getElementById('commsSmallWindow');
            const title = document.getElementById('commsWindowTitle');
            const content = document.getElementById('commsWindowContent');
            
            // Step 1: Set content/title first so offsetHeight is accurate
            title.innerText = "DATA NODE: " + name.toUpperCase();
            
            const displayUrl = url || 'N/A (ONION/CLOSED NETWORK)';
            
            // Find the full entry to get the content/description
            // Filtering by ID and URL (or just ID since all OSINTA are unique by ID)
            const entry = globalLogData.find(item => item.id === name); // Removed category filter for simplicity since ID is primary key in this context
            const description = entry ? entry.content : "No detailed description available.";
            
            // MODIFICATION: Change the button's action to call openExternalViewer
            const actionButton = url && url.startsWith('http')
                ? `<a class="dl-link" onclick="openExternalViewer('${url}', '${name}')" style="background:#004d99; border-color:#0066cc; display:inline-block; margin-top:10px;"><i class="fas fa-external-link-alt"></i> EXECUTE QUERY</a>`
                : `<span style="color:#ff0000; font-weight:bold; font-size:10px; display:block; margin-top:10px;">[ OFFLINE NETWORK REFERENCE ]</span>`;

            // Written content for the window
            const writtenContent = `
                > NODE_ID: ${name}<br>
                > CATEGORY: ${entry ? entry.category : 'OSINTA'}<br>
                > LINK: <span style="color:#00ff41; font-weight:bold;">${displayUrl}</span><br>
                > STATUS: ${url ? 'ONLINE_REF' : 'OFFLINE_REF'}<br>
                -----------------------------<br>
                > DESCRIPTION: ${description}
                ${actionButton}
            `;
            
            content.innerHTML = `<div style="padding: 10px; font-size: 10px; line-height: 1.6;">${writtenContent}</div>`;
            
            // --- START POSITION FIX (Modified Logic for Left/Right) ---
            const rect = triggerElement.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const safeWindowWidth = 500; // #commsSmallWindow width is 500px
            const safeWindowHeight = 450; // Estimated height for the small window
            const margin = 20; 
            
            let newTop = rect.top;
            let newLeft;
            
            // Determine if to open Left or Right based on category (Lost.dir & Log.list open left)
            const openLeft = (category === 'Lost.dir' || category === 'Log.list');
            
            if (openLeft) { // Open Left
                newLeft = rect.left - safeWindowWidth - 10; // rect.left - window width - margin
                // Safety check: if newLeft is too far left, default to opening right 
                if (newLeft < margin) { 
                    newLeft = rect.right + 10; 
                }
            } else { // Open Right (Default for OSINTA and fallback)
                newLeft = rect.right + 10;
                // Secondary safety check: if opening right goes off-screen, try opening left
                if ((rect.right + safeWindowWidth + 10) > viewportWidth) {
                     newLeft = rect.left - safeWindowWidth - 10;
                     // Tertiary check: if trying left also fails (very small screen), revert to original right position
                     if (newLeft < margin) {
                         newLeft = rect.right + 10; // Keep it on the right, even if it overflows
                     }
                }
            }

            // Adjust vertical position (same as before)
            if (rect.top + safeWindowHeight + margin > viewportHeight) {
                // Adjust position to prevent going off-screen bottom
                newTop = viewportHeight - safeWindowHeight - margin;
                
                // Ensure it doesn't go off-screen top (only an issue if viewport is very small)
                if (newTop < margin) {
                    newTop = margin; // Clamp to top margin
                }
            }
            
            win.style.top = newTop + 'px';
            win.style.left = newLeft + 'px'; 
            // --- END POSITION FIX (Modified Logic for Left/Right) ---

            win.style.display = 'block';
        }
        // --- END MODIFIED OSINT FUNCTIONS ---

        // --- UPDATED COMMS WINDOW FUNCTION (FIXED to pass short doc.id instead of huge content string and fix positioning) ---
        function openCommsWindow(category, triggerElement) {
            const win = document.getElementById('commsSmallWindow');
            const title = document.getElementById('commsWindowTitle');
            const content = document.getElementById('commsWindowContent');
            
            // Filter using the docId which is now in globalLogData
            const filteredData = globalLogData.filter(item => item.category === category);
            
            if (filteredData.length === 0) {
                content.innerHTML = `<div style="text-align:center; padding:80px 10px; color:#666;"><i class="fas fa-ban" style="font-size:30px; margin-bottom:15px;"></i><br><span style="font-size:12px; letter-spacing:1px;">NO DATA RECORDS FOUND</span></div>`;
            } else {
                let html = '<table style="width:100%; border-collapse:collapse; font-size:10px;"><thead><tr style="border-bottom:1px solid #444; color:#888;"><th style="text-align:left; padding:8px 5px;">ID</th><th style="text-align:left; padding:8px 5px;">DATE</th><th style="text-align:right; padding:8px 5px;">ACTIONS</th></tr></thead><tbody>';
                
                filteredData.forEach((item) => {
                    // REMOVED: const contentForArg = item.content ? item.content.replace(/'/g, "\\'") : '';
                    
                    // Download File Button: Visible only if fileUrl exists
                    const isFileOrLink = item.fileUrl && item.fileType !== 'link/osint'; 
                    const dlFileBtn = isFileOrLink 
                        ? `<a class="dl-link" onclick="downloadFile('${item.fileUrl}', '${item.fileName || item.id}')" style="background: #333; border-color: #555;"><i class="fas fa-download"></i> FILE</a>` 
                        : (item.fileUrl && item.fileType === 'link/osint'
                            ? `<a class="dl-link" onclick="openExternalViewer('${item.fileUrl}', '${item.fileName || item.id}')" style="background:#004d99; margin-left: 5px;"><i class="fas fa-external-link-alt"></i> LINK</a>`
                            : `<span style="color:#444">N/A</span>`);
                    
                    // NEW: Download Content Button: Visible only if content exists
                    // FIX: Pass only doc.id
                    const dlContentBtn = item.content
                        ? `<a class="dl-link" onclick="downloadContent('${item.docId}')" style="background:#2a2a2a; margin-left: 5px;"><i class="fas fa-file-alt"></i> TEXT</a>`
                        : `<span style="color:#444; margin-left: 5px;">NO TEXT</span>`;

                    // Edit Button
                    // FIX: Pass only doc.id
                    const editBtn = `<a class="dl-link edit-btn" onclick="openEditModal('${item.docId}')" style="margin-left: 5px;"><i class="fas fa-edit"></i> EDIT</a>`;
                    
                    // Delete Button
                    const deleteBtn = `<a class="dl-link" onclick="deleteLog('${item.docId}', '${item.fileUrl || ''}', '${item.id}')" style="background:#ff0000; margin-left: 5px;"><i class="fas fa-trash-alt"></i> DEL</a>`;

                    html += `<tr style="border-bottom:1px solid #222;">
                        <td style="color:#a00000; padding:8px 5px; font-weight:bold;">${item.id}</td>
                        <td style="color:#666; padding:8px 5px;">${item.date.toLocaleDateString()}</td>
                        <td style="text-align:right; padding:8px 5px;">${dlFileBtn} ${dlContentBtn} ${editBtn} ${deleteBtn}</td> <!-- ACTION BUTTONS -->
                    </tr>`;
                });
                html += '</tbody></table>';
                content.innerHTML = html;
            }

            title.innerText = "DATA RECORD: " + category.toUpperCase();
            
            // --- START POSITION FIX ---
            const rect = triggerElement.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            const safeWindowHeight = 450; // Estimated height for the small window (400px content + bar/padding)
            const safeWindowWidth = 500; // Estimated Width
            const margin = 20; // Margin from the edge
            
            let newTop = rect.top;
            let newLeft = rect.right + 10; // Default placement: To the right
            
            // Vertical Check: Check if the bottom of the window will go off-screen
            if (rect.top + safeWindowHeight + margin > viewportHeight) {
                // Adjust position to prevent going off-screen bottom
                newTop = viewportHeight - safeWindowHeight - margin;
                
                // Ensure it doesn't go off-screen top (only an issue if viewport is very small)
                if (newTop < margin) {
                    newTop = margin; // Clamp to top margin
                }
            }

            // Horizontal Check: Check if opening right goes off-screen (Since we have a full width table now)
            if (newLeft + safeWindowWidth > viewportWidth) {
                // Shift it to the left to fit on screen
                newLeft = viewportWidth - safeWindowWidth - margin;
            }
            
            win.style.top = newTop + 'px';
            win.style.left = newLeft + 'px';
            // --- END POSITION FIX ---

            win.style.display = 'block';
        }

        function closeCommsWindow() { document.getElementById('commsSmallWindow').style.display = 'none'; }

        window.addEventListener('click', function(e) {
            if (!e.target.closest('.category-container')) {
                // Keep default category dropdowns open/close logic
                document.querySelectorAll('.category-list').forEach(l => { 
                    if (!l.classList.contains('map-list-permanent') && l.id !== 'comms-cat-list') l.classList.remove('active'); 
                });
            }
            // Close the small window if click is outside the window AND outside the relevant list/triggers
            if (!e.target.closest('#commsSmallWindow') && 
                !e.target.closest('#secure-comms-section .category-list') &&
                !e.target.closest('#network-map-osint-list') && // Updated ID
                !e.target.closest('#network-map-lost-dir-list') && // New ID
                !e.target.closest('#network-map-log-list') // New ID
                ) { 
                 closeCommsWindow(); 
            }
            
            // ADDED: Close external viewer if click is outside
            if (!e.target.closest('#externalViewModal') && !e.target.closest('#commsSmallWindow') && !e.target.closest('.dl-link')) {
                closeExternalViewer(); 
            }
            
            if (!e.target.closest('#editLogModal') && !e.target.closest('.dl-link') && !e.target.closest('#deleteConfirmModal') && !e.target.closest('.modal-btn') && !e.target.closest('#systemLockedPopup')) { 
                closeEditModal(); 
                closeDeleteConfirmModal(); // Close delete modal too
                closeLockedPopup(); // Close locked modal too
            }
        });

        function triggerAccessDenied() { document.getElementById('access-denied-popup').style.display = 'flex'; }
        function closeAdPopup() { document.getElementById('access-denied-popup').style.display = 'none'; }

        function unlockMainSite() {
            const val = document.getElementById('initialPhraseInput').value;
            if(val === "alpha02/sierra0.1X") {
                document.getElementById('entry-page').style.display = 'none';
                document.getElementById('main-wrapper').style.display = 'flex';
                
                // --- ADDED: Auto open dashboard ---
                toggleDashboard(true);
                // ----------------------------------

                showGridToast("ACCESS GRANTED: WELCOME TO AlphaVault/X01");
            } else { triggerAccessDenied(); }
        }

        let currentMode = ""; 
        let savedRange = null; 
        let pendingUploadSource = ""; 

        function toggleMenu() { document.getElementById('dropdownMenu').classList.toggle('open'); }
        function showPage(pageId) {
            document.getElementById('default-content').style.display = 'none';
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('history-section').style.display = 'none';
            document.getElementById('notebook-section').style.display = 'none';
            document.getElementById('secure-comms-section').style.display = 'none';
            document.getElementById('network-map-section').style.display = 'none'; // Hide Network Map section
            document.getElementById(pageId).style.display = 'block';
            document.getElementById('dropdownMenu').classList.remove('open');
            
            if (pageId === 'network-map-section') {
                // When Network Map opens, load all dedicated lists
                renderOsintList();
            }
        }

        function execCmd(command) { document.execCommand(command, false, null); }
        function openCustomPrompt(mode) {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) { savedRange = sel.getRangeAt(0); }
            currentMode = mode;
            const modal = document.getElementById('urlModal');
            const input = document.getElementById('modalInput');
            modal.style.display = "flex";
            input.value = "";
            input.focus();
            document.getElementById('modalConfirmBtn').onclick = function() {
                const val = input.value;
                if(val) {
                    document.getElementById('rich-editor').focus();
                    if (savedRange) {
                        const s = window.getSelection();
                        s.removeAllRanges();
                        s.addRange(savedRange);
                    }
                    if(currentMode === 'LINK') document.execCommand("createLink", false, val);
                }
                closeUrlModal();
            };
        }

        function triggerNotebookFileUpload(type) { /* REMOVED FILE INPUTS */ }
        function handleNotebookFile(input, type) { /* REMOVED FILE LOGIC */ }

        function insertHTMLAtCursor(html) {
            document.getElementById('rich-editor').focus();
            let sel, range;
            if (window.getSelection) {
                sel = window.getSelection();
                if (sel.getRangeAt && sel.rangeCount) {
                    range = sel.getRangeAt(0);
                    range.deleteContents();
                    const el = document.createElement("div");
                    el.innerHTML = html;
                    const frag = document.createDocumentFragment();
                    let node, lastNode;
                    while ((node = el.firstChild)) { lastNode = frag.appendChild(node); }
                    range.insertNode(frag);
                    if (lastNode) {
                        range = range.cloneRange();
                        range.setStartAfter(lastNode);
                        range.collapse(true);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }
            }
        }

        function closeUrlModal() { document.getElementById('urlModal').style.display = "none"; }
        function showGridToast(message) {
            const toast = document.getElementById('grid-toast');
            const msg = document.getElementById('toast-msg');
            msg.innerText = message;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 4000);
        }

        function closeSuccessModal() { document.getElementById('uploadSuccessModal').style.display = 'none'; }
        function closeConfirmModal() { document.getElementById('uploadConfirmModal').style.display = 'none'; }

        function uploadNoteToGrid() {
            if(!globalSystemActive) { 
                showLockedPopup(); // REPLACED: Toast with Popup
                return; 
            }
            pendingUploadSource = "NOTE";
            document.getElementById('securityPhraseInput').value = "";
            document.getElementById('uploadConfirmModal').style.display = 'flex';
        }

        function verifySecurityAndUpload() {
            const phrase = document.getElementById('securityPhraseInput').value;
            if (phrase === "alpha02/sierra0.1X") {
                closeConfirmModal();
                if (pendingUploadSource === "NOTE") startNoteTransmission();
                else if (pendingUploadSource === "DATA") executeNTDataUpload(); // MODIFIED CALL
            } else { closeConfirmModal(); triggerAccessDenied(); }
        }

        function startNoteTransmission() {
            const noteTitle = document.getElementById('notebook-title').value || "NOTEBOOK_ENTRY";
            const category = document.getElementById('notebook-category').value;
            const noteContent = document.getElementById('rich-editor').innerHTML; 
            
            // FIX: Use currentNotebookDocId to determine if updating or adding new
            if (currentNotebookDocId) {
                // UPDATE existing entry
                db.collection("silentgrid_logs").doc(currentNotebookDocId).update({
                    id: noteTitle, 
                    category: category,
                    content: noteContent,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                }).then(() => {
                    showGridToast("NOTEBOOK ENTRY UPDATED: " + noteTitle);
                    document.getElementById('uploadSuccessModal').style.display = 'flex';
                }).catch(err => {
                    showGridToast("UPDATE ERROR: " + err.message);
                });
            } else {
                // UPLOAD as new entry
                db.collection("silentgrid_logs").add({
                    id: noteTitle,
                    category: category,
                    content: noteContent,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then((docRef) => {
                    // Set the current ID for future edits
                    currentNotebookDocId = docRef.id; 
                    showGridToast("NOTEBOOK ENTRY UPLOADED: " + noteTitle);
                    document.getElementById('uploadSuccessModal').style.display = 'flex';
                }).catch(err => {
                    showGridToast("TRANSMISSION ERROR: " + err.message);
                });
            }
        }

        function updateFileList() {
            /* REMOVED FILE LOGIC */
            document.getElementById('fileNames').innerHTML = "FILE UPLOAD MODULES REMOVED";
        }

        document.getElementById('secureUploadForm').onsubmit = function(event) {
            event.preventDefault();
            if(!globalSystemActive) { 
                showLockedPopup(); // REPLACED: Toast with Popup
                return; 
            }
            pendingUploadSource = "DATA";
            document.getElementById('securityPhraseInput').value = "";
            document.getElementById('uploadConfirmModal').style.display = 'flex';
        };

        // --- NEW/MODIFIED: NT DATA UPLOAD LOGIC ---
        function executeNTDataUpload() {
            const fileID = document.getElementById('hist_id').value;
            const category = document.getElementById('upload-category').value;
            const description = document.getElementById('hist_desc').value;
            const url = document.getElementById('hist_url').value;
            const progContainer = document.getElementById('progContainer');
            
            if (!fileID) {
                showGridToast("ERROR: FILE ID REQUIRED");
                return;
            }

            progContainer.style.display = 'block';
            
            // Simulate progress bar and immediate upload since there is no file
            const progBar = document.getElementById('progBar');
            progBar.style.width = '100%';

            // Creating a proper database entry for the uploaded content (Text/URL only)
            db.collection("silentgrid_logs").add({
                id: fileID,
                category: category,
                content: description,
                fileUrl: url || '', // Store the URL here
                fileName: fileID,
                fileType: url ? "link/user" : "text/data",
                fileSize: (description.length + url.length) * 2, // Dummy size calculation
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                progContainer.style.display = 'none';
                document.getElementById('uploadSuccessModal').style.display = 'flex';
                resetUploadForm();
            }).catch((error) => {
                showGridToast("UPLOAD FAILED: " + error.message);
                progContainer.style.display = 'none';
            });
        }
        // --- END NEW/MODIFIED LOGIC ---

        function resetUploadForm() {
            document.getElementById('secureUploadForm').reset();
            document.getElementById('fileNames').innerHTML = "";
            document.getElementById('upload-cat-label').innerText = 'Classification: OSINTA'; // Default to first new category
            document.getElementById('upload-category').value = 'OSINTA';
            document.getElementById('progContainer').style.display = 'none';
        }

        function updateStatusTime() {
            const now = new Date();
            const clock = document.getElementById('realTimeClock');
            if(clock) clock.textContent = `:: ${now.toLocaleTimeString()} ET`;
        }
        setInterval(updateStatusTime, 1000);
        
        // --- NOTEBOOK SPECIFIC DOWNLOAD FUNCTIONS (FIXED) ---
        function downloadNoteAsPDF() {
            // FIX: Use current rich-editor content
            const content = document.getElementById('rich-editor').innerText;
            if (content.trim() === "Write your secure notes here..." || content.trim() === "" || content.trim() === "<p>Write your secure notes here...</p>") {
                showGridToast("ERROR: NOTEBOOK IS EMPTY");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const title = document.getElementById('notebook-title').value || 'Secure_Note_Entry';
            
            doc.setFontSize(18);
            doc.text(title, 10, 10);
            
            doc.setFontSize(12);
            // Use innerText for conversion to PDF
            const lines = doc.splitTextToSize(content, 180);
            doc.text(lines, 10, 20);
            
            doc.save(title + ".pdf");
            showGridToast("PDF DOWNLOADED: " + title);
        }
        
        function downloadNoteAsTXT() {
            // FIX: Use current rich-editor content
            const content = document.getElementById('rich-editor').innerText;
            if (content.trim() === "Write your secure notes here..." || content.trim() === "" || content.trim() === "<p>Write your secure notes here...</p>") {
                showGridToast("ERROR: NOTEBOOK IS EMPTY");
                return;
            }

            const title = document.getElementById('notebook-title').value || 'Secure_Note_Entry';
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', title + ".txt");
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            showGridToast("TXT DOWNLOADED: " + title);
        }

        // --- 1. RENDER CATEGORY MANAGER LIST (Notebook Page) ---
        function refreshCategoryManager() {
            const list = document.getElementById('manage-cat-list');
            list.innerHTML = "";

            // Get all categories currently in the Dropdown
            const dropdown = document.getElementById('notebook-cat-list');
            const items = dropdown.getElementsByTagName('li');
            
            // Convert to array to avoid live collection issues
            Array.from(items).forEach(item => {
                const catName = item.innerText;
                
                // Create List Item
                const li = document.createElement('li');
                li.style.padding = "8px 12px";
                li.style.borderBottom = "1px solid #222";
                li.style.display = "flex";
                li.style.justifyContent = "space-between";
                li.style.alignItems = "center";
                li.style.fontSize = "10px";
                li.style.color = "#ccc";

                // Category Name
                const nameSpan = document.createElement('span');
                nameSpan.innerText = "> " + catName;
                
                // Delete Button
                const delBtn = document.createElement('button');
                delBtn.innerHTML = "[X] DELETE";
                delBtn.style.background = "#330000";
                delBtn.style.border = "1px solid #550000";
                delBtn.style.color = "#ff5555";
                delBtn.style.cursor = "pointer";
                delBtn.style.fontSize = "9px";
                delBtn.style.padding = "2px 6px";
                
                // Delete Action
                delBtn.onclick = function() {
                    deleteCategoryNode(catName, item, li);
                };

                li.appendChild(nameSpan);
                li.appendChild(delBtn);
                list.appendChild(li);
            });
        }

        // --- 2. DELETE CATEGORY FUNCTION ---
        function deleteCategoryNode(catName, dropdownItem, managerItem) {
            if(confirm("CONFIRM DELETION: Remove category '" + catName + "' from list? (Data remains in Grid)")) {
                // Remove from Dropdown
                dropdownItem.remove();
                // Remove from Manager List
                managerItem.remove();
                showGridToast("CATEGORY NODE DELETED: " + catName);
                
                // Reset selection if deleted category was selected
                const currentCat = document.getElementById('notebook-category').value;
                if(currentCat === catName) {
                    selectCategory('notebook', 'General');
                }
            }
        }

        // --- 3. DYNAMIC SECURE COMMS TABLE (The Core Logic) ---
        function updateSecureCommsTable() {
            const tableBody = document.querySelector('.comms-grid-table tbody');
            if(!tableBody) return;

            tableBody.innerHTML = ""; // Clear existing static rows

            // 1. Get all unique categories from the actual uploaded data
            const categories = new Set();
            
            // Add default categories first (optional, ensures they always show)
            ['General', 'Artificial intelligence', 'Cybersecurity', 'Codes', 'Victim', 'Thrate', 'Report', 'Data', 'Informations'].forEach(c => categories.add(c));

            // Add any custom categories found in Firebase data
            globalLogData.forEach(item => {
                if(item.category) categories.add(item.category);
            });

            // 2. Generate Rows for each category
            categories.forEach(cat => {
                // Find data for this category to determine status/date
                const catData = globalLogData.filter(i => i.category === cat);
                const count = catData.length;
                
                // Determine latest date
                let lastSync = "N/A";
                if(catData.length > 0) {
                    // Sort by date desc
                    catData.sort((a,b) => b.date - a.date);
                    const d = catData[0].date;
                    lastSync = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
                } else {
                    // Default date if empty
                    lastSync = new Date().toISOString().slice(0,10); 
                }

                // Determine Status based on data presence
                const statusClass = count > 0 ? "col-status-v" : "col-status-nv";
                const statusText = count > 0 ? "VERIFIED" : "NO DATA";
                const rowColor = count > 0 ? "#ffffff" : "#888";

                // Generate Random/Pseudo IDs for look (consistent hash based on name length)
                const pseudoID = cat.substring(0,2).toUpperCase() + "_" + (1000 + cat.length * 55) + "/X";
                const pseudoSSN = 1000 + cat.length * 12;

                const row = document.createElement('tr');
                row.setAttribute('onclick', `selectComms('${cat}', event)`);
                
                row.innerHTML = `
                    <td>${cat.toUpperCase()}</td>
                    <td class="col-id">${pseudoID}</td>
                    <td>${pseudoSSN}</td>
                    <td>GRID SCAN</td>
                    <td>DAT</td>
                    <td>${count}</td>
                    <td>${lastSync}</td>
                    <td class="${statusClass}">${statusText}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Also update the manager list in notebook
            refreshCategoryManager();
        }

        // --- NEW FUNCTION: BUILD CATEGORY (Modified to trigger updates) ---
        function buildAndSelectCategory() {
            const input = document.getElementById('new-cat-input');
            const newCatName = input.value.trim();
            
            // Validate input
            if (!newCatName) {
                showGridToast("ERROR: CATEGORY NAME CANNOT BE EMPTY");
                return;
            }

            // Get the notebook specific list
            const list = document.getElementById('notebook-cat-list');

            // Create the new list item
            const li = document.createElement('li');
            li.innerText = newCatName;
            li.style.color = "#00ff41"; // Style for user-generated categories
            
            // Add the click event
            li.onclick = function() { 
                selectCategory('notebook', newCatName); 
            };

            // Add to the Dropdown List
            list.appendChild(li);

            // Automatically select this new category immediately
            selectCategory('notebook', newCatName);

            // Visual feedback
            showGridToast("SYSTEM: NEW CATEGORY NODE BUILT [" + newCatName + "]");
            
            // Clear input
            input.value = "";

            // Refresh the manager list immediately
            refreshCategoryManager();
            // Update comms table to show empty row for new category
            updateSecureCommsTable();
        }
    </script>
</body>
</html>
